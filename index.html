<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
<title>梦角爱人 - 私密聊天</title>
<style>
/* 主题色变量 - 日间模式 */
:root {
  --bg-main: #bfbfbf;
  --bg-panel: rgba(229, 229, 229, 0.85);
  --msg-self: #dedede;
  --msg-other: #f2f2f2;
  --text: #5c5c5c;
  --accent: #8a7f8d;
  --accent-light: #a99cad;
  --accent-gray: #9e9e9e;
  --accent-gray-light: #bdbdbd;
  --online: #4caf50;
  --busy: #ff9800;
  --dr: #2196f3;
  --cr: #9c27b0;
  --nearby: #ff5722;
  --mood-happy: #ffcc00;
  --mood-normal: #4caf50;
  --mood-sad: #9c27b0;
  --mood-angry: #f44336;
  --quote-bg: rgba(138, 127, 141, 0.1);
  --call-bg: rgba(33, 150, 243, 0.1);
  --call-text: #2196f3;
  --video-bg: rgba(156, 39, 176, 0.1);
  --video-text: #9c27b0;
  --tarot-bg: rgba(156, 39, 176, 0.1);
  --tarot-text: #7b1fa2;
  --border-color: rgba(92, 92, 92, 0.1);
  --input-bg: rgba(255, 255, 255, 0.7);
}

/* ===== 重新设计的夜间模式 - 整个页面完全变黑，无白边 ===== */
.night-mode {
  /* 主要背景 - 深色 */
  --bg-main: #0a0a0a !important;
  --bg-panel: rgba(0, 0, 0, 0.95) !important;
  
  /* 消息气泡 - 更深的灰色 */
  --msg-self: #1a1a1a !important;
  --msg-other: #222222 !important;
  
  /* 文字颜色 - 浅灰色/白色，提高可读性 */
  --text: #e0e0e0 !important;
  
  /* 强调色 - 稍微调亮 */
  --accent: #b3a6b5 !important;
  --accent-light: #c4b7c7 !important;
  
  /* 灰色按钮 - 更深 */
  --accent-gray: #333333 !important;
  --accent-gray-light: #555555 !important;
  
  /* 状态颜色 - 调暗但保持可辨识 */
  --online: #1b5e20 !important;
  --busy: #b26a00 !important;
  --dr: #0d47a1 !important;
  --cr: #4a148c !important;
  --nearby: #b53d1a !important;
  
  /* 引用和特殊背景 - 半透明深色 */
  --quote-bg: rgba(180, 170, 190, 0.15) !important;
  --call-bg: rgba(33, 150, 243, 0.2) !important;
  --call-text: #90caf9 !important;
  --video-bg: rgba(156, 39, 176, 0.2) !important;
  --video-text: #ce93d8 !important;
  --tarot-bg: rgba(156, 39, 176, 0.2) !important;
  --tarot-text: #ce93d8 !important;
  
  /* 边框颜色 - 深色 */
  --border-color: #222222 !important;
  --input-bg: rgba(30, 30, 30, 0.9) !important;
}

/* 夜间模式下的全局背景 - 确保完全覆盖 */
.night-mode,
.night-mode body,
.night-mode html {
  background: #0a0a0a !important;
  background-image: none !important;
  background-color: #0a0a0a !important;
  margin: 0 !important;
  padding: 0 !important;
  min-height: 100vh !important;
  height: 100% !important;
  width: 100% !important;
  position: relative !important;
}

/* 夜间模式下主容器背景完全黑色 */
.night-mode .container {
  background: transparent !important;
}

/* 夜间模式下背景容器完全黑色覆盖 */
.night-mode .background-container {
  background: #0a0a0a !important;
  background-image: none !important;
  opacity: 1 !important;
}

/* 如果有背景图片，在夜间模式下也变暗处理 */
.night-mode .background-container[style*="background-image"] {
  filter: brightness(0.15) contrast(1.2) !important;
  background-size: cover !important;
  background-position: center !important;
}

/* 夜间模式下的所有边框和分隔线 */
.night-mode .settings-header,
.night-mode .settings-tabs,
.night-mode .ratio-controls,
.night-mode .appearance-controls,
.night-mode .communication-controls,
.night-mode .background-controls,
.night-mode .tarot-controls,
.night-mode .export-controls,
.night-mode .cloud-controls,
.night-mode .music-list,
.night-mode .sticker-preview,
.night-mode .preset-btn,
.night-mode .message-avatar,
.night-mode .chat-subtitle,
.night-mode .love-days,
.night-mode .nickname {
  border-color: #222 !important;
}

/* 夜间模式下的输入框 */
.night-mode .message-input {
  background: rgba(30, 30, 30, 0.9) !important;
  color: #e0e0e0 !important;
  border: 1px solid #333 !important;
}

/* 夜间模式下的所有文本区域和选择框 */
.night-mode .message-input,
.night-mode .appearance-input,
.night-mode .date-input,
.night-mode .phrases-textarea,
.night-mode .tarot-textarea,
.night-mode .max-count-select,
.night-mode .auto-send-select,
.night-mode .cloud-textarea {
  background: rgba(30, 30, 30, 0.9) !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}

.night-mode .appearance-input:focus,
.night-mode .date-input:focus,
.night-mode .phrases-textarea:focus,
.night-mode .tarot-textarea:focus,
.night-mode .cloud-textarea:focus {
  background: rgba(40, 40, 40, 0.95) !important;
  border-color: #b3a6b5 !important;
}

/* 夜间模式下的标题文字 */
.night-mode .chat-title-area h1 {
  color: #d0d0d0 !important;
}

/* 夜间模式下的副标题和恋爱天数气泡 */
.night-mode .chat-subtitle,
.night-mode .love-days {
  color: #e0b5b5 !important;
  background: rgba(40, 20, 25, 0.7) !important;
  border-color: rgba(100, 60, 70, 0.5) !important;
}

/* 夜间模式下的昵称气泡 */
.night-mode .nickname {
  color: #e0b5b5 !important;
  background: rgba(40, 20, 25, 0.7) !important;
  border-color: rgba(100, 60, 70, 0.5) !important;
}

/* 夜间模式下的设置面板 */
.night-mode .settings-panel {
  background: rgba(0, 0, 0, 0.98) !important;
  backdrop-filter: blur(12px) !important;
  border-left: 1px solid #222 !important;
}

/* 夜间模式下的设置面板头部 */
.night-mode .settings-header {
  border-bottom-color: #222 !important;
}

/* 夜间模式下的设置面板标题 */
.night-mode .settings-header h2 {
  color: #d0d0d0 !important;
}

/* 夜间模式下的标签页按钮 */
.night-mode .tab-button {
  color: #aaa !important;
}

.night-mode .tab-button.active {
  color: #c0b0c0 !important;
  border-bottom-color: #b3a6b5 !important;
}

/* 夜间模式下的所有设置区域背景 */
.night-mode .ratio-controls,
.night-mode .appearance-controls,
.night-mode .communication-controls,
.night-mode .background-controls,
.night-mode .tarot-controls,
.night-mode .export-controls,
.night-mode .cloud-controls,
.night-mode .sticker-preview,
.night-mode .music-list,
.night-mode .active-call-controls,
.night-mode .communication-stats,
.night-mode .music-upload-area {
  background: rgba(20, 20, 20, 0.9) !important;
  border: 1px solid #222 !important;
}

/* 夜间模式下的音乐播放器 */
.night-mode .music-window {
  background: rgba(0, 0, 0, 0.98) !important;
  border: 1px solid #222 !important;
}

.night-mode .music-window .window-header {
  background: rgba(10, 10, 10, 0.95) !important;
  border-bottom: 1px solid #222 !important;
}

.night-mode .music-title {
  color: #e0e0e0 !important;
}

.night-mode .music-item-card {
  background: rgba(20, 20, 20, 0.9) !important;
  border: 1px solid #222 !important;
}

.night-mode .music-item-name {
  color: #e0e0e0 !important;
}

/* 夜间模式下的通话/视频窗口 */
.night-mode .call-window,
.night-mode .video-window {
  background: rgba(0, 0, 0, 0.98) !important;
  border: 1px solid #222 !important;
}

.night-mode .window-header {
  background: rgba(10, 10, 10, 0.95) !important;
  color: #e0e0e0 !important;
  border-bottom: 1px solid #222 !important;
}

.night-mode .window-title {
  color: #e0e0e0 !important;
}

.night-mode .window-btn {
  background: rgba(60, 60, 60, 0.3) !important;
  color: #ccc !important;
}

.night-mode .window-btn:hover {
  background: rgba(80, 80, 80, 0.5) !important;
}

/* 夜间模式下的消息操作菜单 */
.night-mode .message-actions {
  background: #222 !important;
  border: 1px solid #333 !important;
}

.night-mode .message-action-btn {
  color: #ccc !important;
}

.night-mode .message-action-btn:hover {
  background: #444 !important;
  color: white !important;
}

/* 夜间模式下的引用消息 */
.night-mode .quoted-message {
  background: rgba(80, 70, 80, 0.2) !important;
  border-left-color: #b3a6b5 !important;
}

/* 夜间模式下的已读不回提示 */
.night-mode .read-no-reply {
  color: #ffb74d !important;
}

/* 夜间模式下的模态框 */
.night-mode .modal-content {
  background: rgba(0, 0, 0, 0.98) !important;
  border: 1px solid #222 !important;
}

.night-mode .modal-title {
  color: #d0d0d0 !important;
}

.night-mode .modal-btn.secondary {
  background: rgba(50, 50, 50, 0.3) !important;
  color: #e0e0e0 !important;
  border: 1px solid #222 !important;
}

/* 夜间模式下的预设按钮 */
.night-mode .preset-btn {
  background: #222 !important;
  color: #ccc !important;
  border-color: #333 !important;
}

.night-mode .preset-btn:hover {
  background: #444 !important;
  color: white !important;
}

.night-mode .preset-btn.active {
  background: #b3a6b5 !important;
  color: #0a0a0a !important;
}

/* 夜间模式下的开关 */
.night-mode .slider {
  background-color: #444 !important;
}

/* 夜间模式下的状态文字和心情指数 */
.night-mode .status-text,
.night-mode .mood-percentage {
  color: #ccc !important;
}

/* 夜间模式下的通话统计区域 */
.night-mode .communication-stats p {
  color: #ccc !important;
}

/* 夜间模式下的各种提示文字 */
.night-mode .phrases-info,
.night-mode .tarot-info,
.night-mode .cloud-info {
  color: #aaa !important;
}

/* 夜间模式下的表情包预览区域 */
.night-mode .sticker-item {
  background: rgba(40, 40, 40, 0.8) !important;
  border-color: #333 !important;
}

.night-mode .sticker-placeholder {
  color: rgba(200, 200, 200, 0.3) !important;
}

/* 夜间模式下的音乐上传区域 */
.night-mode .music-upload-area {
  background: rgba(20, 20, 20, 0.8) !important;
  border-color: #333 !important;
}

.night-mode .music-upload-area:hover {
  background: rgba(40, 40, 40, 0.9) !important;
  border-color: #b3a6b5 !important;
}

/* 夜间模式下的滚动条 */
.night-mode ::-webkit-scrollbar-track {
  background: #1a1a1a !important;
}

.night-mode ::-webkit-scrollbar-thumb {
  background: #444 !important;
}

.night-mode ::-webkit-scrollbar-thumb:hover {
  background: #666 !important;
}

/* 夜间模式下的所有文字颜色统一 */
.night-mode p,
.night-mode span,
.night-mode div:not(.message):not(.nickname):not(.chat-subtitle):not(.love-days) {
  color: var(--text) !important;
}

/* 夜间模式下的标题区域文字 */
.night-mode .chat-title-area h1 {
  color: #e0e0e0 !important;
}

/* 夜间模式下的恋爱天数图标 */
.night-mode .love-days i {
  color: #e0b5b5 !important;
}

/* 夜间模式下的恋爱天数数字 */
.night-mode #loveDaysCount {
  color: #e0b5b5 !important;
}

/* 夜间模式下的导出选项标签 */
.night-mode .export-option label {
  color: #e0e0e0 !important;
}

/* 夜间模式下的复选框 */
.night-mode .export-option input[type="checkbox"] {
  accent-color: #b3a6b5 !important;
}

/* 夜间模式下的单选按钮 */
.night-mode input[type="radio"] {
  accent-color: #b3a6b5 !important;
}

/* 夜间模式下的文本标签 */
.night-mode label {
  color: #e0e0e0 !important;
}

/* 夜间模式下的背景预览空状态 */
.night-mode .background-preview.empty {
  background: rgba(20, 20, 20, 0.8) !important;
}

.night-mode .background-preview.empty i,
.night-mode .background-preview.empty span {
  color: rgba(200, 200, 200, 0.3) !important;
}

/* 夜间模式下的背景选项 */
.night-mode .background-option.color {
  background: #1a1a1a !important;
  color: #e0e0e0 !important;
}

/* 夜间模式下的音乐空状态 */
.night-mode .music-empty {
  color: #aaa !important;
}

/* 夜间模式下的音乐空状态图标 */
.night-mode .music-empty i {
  color: #aaa !important;
}

/* 夜间模式下的音乐控制按钮 */
.night-mode .music-control-btn {
  background: rgba(50, 50, 50, 0.3) !important;
  color: #ccc !important;
}

.night-mode .music-control-btn:hover {
  background: #8a7f8d !important;
  color: white !important;
}

/* 夜间模式下的音乐进度条 */
.night-mode .music-progress-bar {
  background: rgba(255, 255, 255, 0.1) !important;
}

.night-mode .music-progress-fill {
  background: linear-gradient(90deg, #b3a6b5, #8a7f8d) !important;
}

.night-mode .music-progress-handle {
  background: #e0e0e0 !important;
  border-color: #b3a6b5 !important;
}

/* 夜间模式下的音乐时间显示 */
.night-mode .music-time span {
  color: #aaa !important;
}

/* 夜间模式下的音乐艺术家 */
.night-mode .music-artist {
  color: #888 !important;
}

/* 夜间模式下的音乐艺术家图标 */
.night-mode .music-artist i {
  color: #888 !important;
}

/* 夜间模式下的正在输入指示器 */
.night-mode .typing-indicator {
  background: #1a1a1a !important;
}

.night-mode .typing-indicator .dot {
  background-color: #e0e0e0 !important;
}

/* 夜间模式下的消息头像边框 */
.night-mode .message-avatar {
  border-color: #222 !important;
}

/* 夜间模式下的消息状态单勾 */
.night-mode .status-check.single {
  color: #aaa !important;
}

/* 夜间模式下的通话按钮 */
.night-mode .call-button,
.night-mode .video-button {
  background: #1a1a1a !important;
  color: #e0e0e0 !important;
  border-color: #333 !important;
}

.night-mode .call-button:hover,
.night-mode .video-button:hover {
  background: #333 !important;
  color: white !important;
  border-color: #444 !important;
}

/* 夜间模式下的接听/拒绝按钮 */
.night-mode .accept-btn {
  background: #1b5e20 !important;
}

.night-mode .reject-btn,
.night-mode .end-btn {
  background: #b71c1c !important;
}

/* 夜间模式下的通话中文字 */
.night-mode .in-call-text {
  color: #ccc !important;
  background: rgba(255, 255, 255, 0.1) !important;
}

/* 夜间模式下的通话计时器 */
.night-mode .call-timer {
  color: #e0e0e0 !important;
}

/* 夜间模式下的通话/视频头像边框 */
.night-mode .call-avatar,
.night-mode .video-avatar {
  border-color: #333 !important;
}

/* 夜间模式下的通话/视频窗口顶部边框 */
.night-mode .call-window,
.night-mode .video-window {
  border-top-color: #333 !important;
}

/* 夜间模式下的通话记录消息 */
.night-mode .call-message,
.night-mode .video-message {
  background: rgba(50, 50, 50, 0.2) !important;
  border-left-color: #333 !important;
}

/* 夜间模式下的塔罗牌消息 */
.night-mode .tarot-message {
  background: rgba(80, 20, 90, 0.2) !important;
  border-left-color: #ce93d8 !important;
}

/* 夜间模式下的遮罩层 */
.night-mode .settings-overlay {
  background: rgba(0, 0, 0, 0.7) !important;
}

/* 夜间模式下的通知 */
.night-mode .notification {
  background: #1a1a1a !important;
  color: #e0e0e0 !important;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5) !important;
}

/* 夜间模式下的所有输入框占位符 */
.night-mode input::placeholder,
.night-mode textarea::placeholder {
  color: #888 !important;
}

/* 夜间模式下的所有边框 */
.night-mode hr {
  border-color: #222 !important;
}

/* 夜间模式下的选择框选项 */
.night-mode select option {
  background: #1a1a1a !important;
  color: #e0e0e0 !important;
}

/* 基础样式 */
body {
  margin: 0;
  height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-main);
  background-image: radial-gradient(#ffffff55 2px, transparent 2px);
  background-size: 30px 30px;
  display: flex;
  justify-content: center;
  align-items: center;
  color: var(--text);
  overflow: hidden;
  transition: background 0.5s ease;
}

/* 背景图片容器 - 确保完全覆盖 */
.background-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transition: opacity 0.5s ease, filter 0.5s ease;
}

/* 主容器 - 移动端优化 */
.container {
  width: 100%;
  max-width: 900px;
  height: 90vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  padding: 10px;
  box-sizing: border-box;
  position: relative;
  z-index: 1;
}

/* 聊天头部区域 - 移动端优化 */
.chat-header {
  width: 100%;
  max-width: 800px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
  flex-wrap: wrap;
}

/* 用户信息区域 - 移动端优化 */
.user-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 65px;
  cursor: pointer;
  position: relative;
  margin-top: 10px;
}

/* 昵称 - 放到头像上方 */
.user-info .nickname {
  order: 1;
  margin-bottom: 4px;
  margin-top: 0;
  font-size: 0.7rem;
  padding: 4px 12px;
  max-width: 100%;
  overflow: visible;
  white-space: normal;
  word-break: break-word;
  line-height: 1.2;
}

/* 头像 - 放到昵称下方 */
.user-info .avatar {
  order: 2;
  margin-bottom: 2px;
}

/* 状态指示器 - 位置调整 */
.user-info .status-indicator {
  order: 3;
  top: 35px;
  right: 8px;
  width: 8px;
  height: 8px;
}

/* 状态文字 - 放到头像下方 */
.user-info .status-text {
  order: 4;
  margin-top: 2px;
  font-size: 0.6rem;
  height: 12px;
}

/* 心情指数 - 放到状态文字下方 */
.user-info .mood-percentage {
  order: 5;
  margin-top: 2px;
  font-size: 0.6rem;
  height: 12px;
}

/* 对方状态指示器特殊调整 */
#otherUserInfo .status-indicator {
  top: 38px;
}

/* 自己状态指示器特殊调整 */
#selfUserInfo .status-indicator {
  top: 38px;
}

/* 修改：头像样式 */
.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  overflow: hidden;
  margin-bottom: 2px;
  background-color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar span {
  display: none;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* 心情指数 */
.mood-percentage {
  font-size: 0.6rem;
  color: var(--text);
  margin-top: 2px;
  text-align: center;
  height: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
}

/* 状态指示器 */
.status-indicator {
  position: absolute;
  top: 0;
  right: 8px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  border: 2px solid var(--bg-panel);
  z-index: 2;
}

.status-indicator.online {
  background-color: var(--online);
}

.status-indicator.busy {
  background-color: var(--busy);
}

.status-indicator.dr {
  background-color: var(--dr);
}

.status-indicator.cr {
  background-color: var(--cr);
}

.status-indicator.nearby {
  background-color: var(--nearby);
}

/* 状态文字 */
.status-text {
  font-size: 0.6rem;
  color: var(--text);
  opacity: 0.8;
  margin-top: 2px;
  text-align: center;
  height: 12px;
}

/* 昵称 - 淡粉色INS玻璃气泡 - 移动端优化 */
.nickname {
  font-size: 0.7rem;
  text-align: center;
  max-width: 100%;
  overflow: visible;
  white-space: normal;
  word-break: break-word;
  color: #b27c7c;
  margin-top: 4px;
  padding: 4px 12px;
  background: rgba(255, 220, 225, 0.2);
  backdrop-filter: blur(12px);
  border-radius: 40px;
  border: 0.5px solid rgba(255, 200, 200, 0.5);
  font-weight: 500;
  letter-spacing: 0.3px;
  box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  animation: floatNickname 3s ease-in-out infinite;
  transition: all 0.3s ease;
  line-height: 1.2;
}

/* 对方昵称 - 漂浮更高、更慢 */
#otherNickname.nickname {
  animation: floatNicknameOther 4s ease-in-out infinite;
  background: rgba(255, 220, 230, 0.2);
}

/* 自己昵称 - 漂浮更轻快 */
#selfNickname.nickname {
  animation: floatNicknameSelf 2.8s ease-in-out infinite;
  background: rgba(255, 220, 230, 0.2);
}

/* 昵称漂浮动画 */
@keyframes floatNickname {
  0% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
  50% {
    transform: translateY(-3px);
    box-shadow: 0 10px 18px rgba(255, 160, 170, 0.25), inset 0 1px 6px rgba(255, 255, 255, 0.9);
    background: rgba(255, 225, 230, 0.3);
  }
  100% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
}

@keyframes floatNicknameOther {
  0% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
  50% {
    transform: translateY(-6px);
    box-shadow: 0 12px 22px rgba(255, 160, 170, 0.28), inset 0 1px 6px rgba(255, 255, 255, 0.9);
    background: rgba(255, 220, 230, 0.35);
  }
  100% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
}

@keyframes floatNicknameSelf {
  0% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
  50% {
    transform: translateY(-4px);
    box-shadow: 0 10px 18px rgba(255, 160, 170, 0.26), inset 0 1px 6px rgba(255, 255, 255, 0.9);
    background: rgba(255, 225, 235, 0.32);
  }
  100% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
}

/* 悬停时 - 浮动暂停，粉色加深 */
.nickname:hover {
  animation: none;
  transform: translateY(-4px) scale(1.02);
  background: rgba(255, 210, 220, 0.45);
  border-color: rgba(255, 180, 190, 0.7);
  box-shadow: 0 14px 24px rgba(255, 150, 160, 0.3), inset 0 1px 6px rgba(255, 255, 255, 0.9);
  color: #a57272;
}

#otherNickname.nickname:hover,
#selfNickname.nickname:hover {
  background: rgba(255, 200, 215, 0.5);
  border-color: rgba(255, 170, 180, 0.75);
  color: #a57272;
}

/* 聊天标题区域 - 移动端优化 */
.chat-title-area {
  text-align: center;
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 0;
  padding: 0 3px;
  max-width: 50%;
}

.chat-title-area h1 {
  margin: 0;
  font-weight: 300;
  font-size: 1.2rem;
  color: var(--accent);
  letter-spacing: 0.5px;
  line-height: 1.2;
  white-space: normal;
  word-break: break-word;
  max-width: 100%;
}

/* 副标题 - 移动端优化 */
.chat-subtitle {
  margin: 4px 0 0;
  font-size: 0.65rem;
  color: #b27c7c;
  max-width: 100%;
  overflow: visible;
  white-space: normal;
  word-break: break-word;
  padding: 4px 12px;
  background: rgba(255, 220, 225, 0.2);
  backdrop-filter: blur(10px);
  border-radius: 40px;
  border: 0.5px solid rgba(255, 200, 200, 0.5);
  box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  font-weight: 400;
  letter-spacing: 0.3px;
  animation: floatSubtitle 4s ease-in-out infinite;
  transition: all 0.3s ease;
  display: inline-block;
  line-height: 1.2;
}

@keyframes floatSubtitle {
  0% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
  50% {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(255, 160, 170, 0.25), inset 0 1px 6px rgba(255, 255, 255, 0.9);
    background: rgba(255, 225, 230, 0.3);
  }
  100% {
    transform: translateY(0px);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
}

.chat-subtitle:hover {
  animation: none;
  transform: translateY(-2px) scale(1.01);
  background: rgba(255, 210, 220, 0.4);
  border-color: rgba(255, 180, 190, 0.7);
  box-shadow: 0 10px 20px rgba(255, 150, 160, 0.3), inset 0 1px 6px rgba(255, 255, 255, 0.9);
  color: #a57272;
}

/* 恋爱天数 - 淡粉色INS玻璃气泡 - 移到设置面板顶部右侧 */
.love-days {
  margin-left: 8px;
  font-size: 0.65rem;
  color: #b27c7c;
  display: inline-flex;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  padding: 4px 12px;
  border-radius: 50px;
  background: rgba(255, 220, 225, 0.25);
  backdrop-filter: blur(10px);
  border: 0.5px solid rgba(255, 200, 200, 0.5);
  box-shadow: 0 4px 12px rgba(255, 180, 190, 0.2), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  white-space: nowrap;
  letter-spacing: 0.3px;
  font-weight: 500;
  animation: floatLove 4s ease-in-out infinite;
  transition: all 0.3s ease;
  position: relative;
}

@keyframes floatLove {
  0% {
    transform: translateY(0px) scale(1);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
  50% {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 0 10px 20px rgba(255, 160, 170, 0.25), inset 0 1px 6px rgba(255, 255, 255, 0.9);
    background: rgba(255, 225, 230, 0.3);
  }
  100% {
    transform: translateY(0px) scale(1);
    box-shadow: 0 4px 12px rgba(255, 180, 190, 0.15), inset 0 1px 4px rgba(255, 255, 255, 0.8);
  }
}

.love-days:hover {
  animation: none;
  transform: translateY(-3px) scale(1.02);
  background: rgba(255, 210, 220, 0.4);
  border-color: rgba(255, 180, 190, 0.7);
  box-shadow: 0 12px 24px rgba(255, 150, 160, 0.3), inset 0 1px 6px rgba(255, 255, 255, 0.9);
}

.love-days i {
  font-size: 0.75rem;
  color: #c28b8b;
  transition: all 0.3s ease;
}

.love-days:hover i {
  transform: scale(1.1);
  color: #b47a7a;
}

#loveDaysCount {
  color: #9d6b6b;
  font-weight: 500;
}

/* ===== 夜间模式切换按钮 ===== */
.theme-toggle {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(138, 127, 141, 0.3);
  flex-shrink: 0;
}

.theme-toggle:hover {
  background: var(--accent-light);
  transform: rotate(30deg);
}

.theme-toggle i {
  color: white;
  font-size: 1rem;
}
/* ================================ */

/* 设置齿轮按钮 */
.settings-toggle {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(138, 127, 141, 0.3);
  flex-shrink: 0;
}

.settings-toggle:hover {
  background: var(--accent-light);
  transform: rotate(30deg);
}

.settings-toggle i {
  color: white;
  font-size: 1rem;
}

/* 右侧按钮组 - 新布局 */
.right-buttons {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-direction: column;
  margin-left: 5px;
}

/* 聊天区域 */
.chat-section {
  width: 100%;
  height: calc(100% - 110px);
  max-width: 800px;
  display: flex;
  flex-direction: column;
}

.chat-container {
  width: 100%;
  height: 100%;
  background: transparent;
  border-radius: 16px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

/* 聊天消息区域 */
.messages-area {
  flex: 1;
  overflow-y: auto;
  padding: 6px 2px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 8px;
}

/* 消息容器 */
.message-container {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  max-width: 100%;
}

.message-container.self {
  flex-direction: row-reverse;
}

.message-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 1px solid rgba(92, 92, 92, 0.2);
}

.message-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.message-content {
  max-width: 75%;
  display: flex;
  flex-direction: column;
  position: relative;
}

.message-container.self .message-content {
  align-items: flex-end;
}

.message-container.other .message-content {
  align-items: flex-start;
}

/* 消息样式 */
.message {
  max-width: 100%;
  padding: 6px 10px;
  border-radius: 14px;
  line-height: 1.3;
  word-wrap: break-word;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
  font-size: 0.85rem;
  position: relative;
  cursor: pointer;
  transition: background-color 0.2s;
}

.message:hover {
  opacity: 0.95;
}

.message.self {
  background: var(--msg-self);
  border-bottom-right-radius: 4px;
}

.message.other {
  background: var(--msg-other);
  border-bottom-left-radius: 4px;
}

.message-time {
  font-size: 0.6rem;
  opacity: 0.6;
  margin-top: 3px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 4px;
}

/* 消息操作菜单 */
.message-actions {
  position: absolute;
  top: -36px;
  background: white;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: none;
  flex-direction: row;
  z-index: 10;
  overflow: hidden;
  padding: 1px;
}

.message-container.self .message-actions {
  right: 0;
}

.message-container.other .message-actions {
  left: 0;
}

.message-action-btn {
  padding: 6px 12px;
  border: none;
  background: transparent;
  font-size: 0.75rem;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  color: var(--accent-gray);
  border-radius: 4px;
  margin: 1px;
}

.message-action-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  transform: translateY(-1px);
}

.message-action-btn.delete,
.message-action-btn.quote,
.message-action-btn.recall {
  color: var(--accent-gray);
}

/* 消息状态 */
.message-status {
  display: flex;
  align-items: center;
  gap: 2px;
  font-size: 0.6rem;
}

.status-check {
  font-size: 0.7rem;
}

.status-check.single {
  color: #888;
}

.status-check.double {
  color: var(--accent);
}

/* 已读不回提示 */
.read-no-reply {
  color: var(--busy);
  font-size: 0.6rem;
  margin-top: 2px;
  display: flex;
  align-items: center;
  gap: 3px;
}

/* 引用消息样式 */
.quoted-message {
  background: var(--quote-bg);
  padding: 4px 6px;
  border-radius: 6px;
  margin-bottom: 4px;
  border-left: 3px solid var(--accent);
  font-size: 0.75rem;
  opacity: 0.9;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
}

.quoted-message img {
  max-height: 16px;
  border-radius: 4px;
  vertical-align: middle;
  margin-right: 4px;
}

/* 对方正在输入动画 */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  background: var(--msg-other);
  border-radius: 14px;
  align-self: flex-start;
  max-width: 120px;
  margin-bottom: 4px;
  opacity: 0;
  transition: opacity 0.3s;
  margin-left: 34px;
  font-size: 0.75rem;
}

.typing-indicator.active {
  opacity: 1;
}

.typing-indicator .dot {
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background-color: var(--text);
  opacity: 0.4;
  animation: typingAnimation 1.5s infinite ease-in-out;
}

.typing-indicator .dot:nth-child(1) {
  animation-delay: 0s;
}

.typing-indicator .dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator .dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typingAnimation {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.4;
  }
  30% {
    transform: translateY(-3px);
    opacity: 0.8;
  }
}

/* 输入区域 - 移动端优化 */
.input-area {
  display: flex;
  gap: 4px;
  align-items: flex-end;
  position: relative;
}

.input-area-buttons {
  display: flex;
  gap: 4px;
  align-items: center;
  flex-wrap: nowrap;
  width: 100%;
}

.message-input {
  flex: 1;
  min-width: 120px;
  padding: 10px 14px;
  border: none;
  border-radius: 20px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.85rem;
  color: var(--text);
  outline: none;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
}

.message-input:focus {
  background: rgba(255, 255, 255, 0.9);
}

.send-button {
  padding: 10px 16px;
  border: none;
  border-radius: 20px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(158, 158, 158, 0.3);
  white-space: nowrap;
}

.send-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-1px);
}

.send-button:active {
  transform: translateY(0);
}

.continue-button {
  width: 38px;
  height: 38px;
  padding: 0;
  border: none;
  border-radius: 20px;
  background: var(--accent-gray);
  color: white;
  font-size: 1.2rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(158, 158, 158, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.continue-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-1px);
}

.upload-image-button {
  width: 38px;
  height: 38px;
  border-radius: 20px;
  background: var(--accent-gray);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(158, 158, 158, 0.3);
  flex-shrink: 0;
}

.upload-image-button:hover {
  background: var(--accent-gray-light);
  transform: translateY(-1px);
}

.upload-image-button i {
  font-size: 1.1rem;
}

/* 设置面板 */
.settings-panel {
  position: fixed;
  top: 0;
  right: -100%;
  width: 90%;
  max-width: 400px;
  height: 100vh;
  background: var(--bg-panel);
  backdrop-filter: blur(12px);
  box-shadow: -5px 0 25px rgba(0, 0, 0, 0.15);
  transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

@media (min-width: 768px) {
  .settings-panel {
    width: 420px;
    right: -450px;
  }
}

.settings-panel.active {
  right: 0;
}

.settings-header {
  padding: 15px;
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.settings-header h2 {
  margin: 0;
  font-weight: 400;
  color: var(--accent);
  font-size: 1.4rem;
}

.close-settings {
  background: none;
  border: none;
  font-size: 1.4rem;
  color: var(--text);
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.close-settings:hover {
  opacity: 1;
  background: rgba(92, 92, 92, 0.1);
}

/* 设置头部右侧 - 放置恋爱天数 */
.settings-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* 设置内容区域 */
.settings-content {
  flex: 1;
  overflow-y: auto;
  padding: 0 15px 15px;
}

/* 设置标签栏 - 字体放大优化 */
.settings-tabs {
  display: flex;
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 2px;
}

.tab-button {
  flex: 1 1 auto;
  padding: 12px 6px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--text);
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
  min-width: 70px;
  white-space: nowrap;
  line-height: 1.3;
}

.tab-button.active {
  border-bottom-color: var(--accent);
  color: var(--accent);
  font-weight: 600;
}

/* 移动端适配 - 标签栏 */
@media (max-width: 768px) {
  .tab-button {
    font-size: 0.85rem;
    padding: 10px 4px;
    min-width: 60px;
  }
}

@media (max-width: 480px) {
  .tab-button {
    font-size: 0.8rem;
    padding: 8px 2px;
    min-width: 55px;
  }
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* 各个模块标题字体放大 */
.sticker-library h3,
.phrases-library h3,
.ratio-library h3,
.appearance-library h3,
.export-library h3,
.communication-library h3,
.cloud-library h3,
.background-library h3,
.tarot-library h3,
.music-library h3 {
  margin-top: 0;
  margin-bottom: 12px;
  font-weight: 500;
  color: var(--accent);
  font-size: 1.2rem;
}

.sticker-library p,
.phrases-library p,
.ratio-library p,
.appearance-library p,
.export-library p,
.communication-library p,
.cloud-library p,
.background-library p,
.tarot-library p,
.music-library p {
  margin: 0 0 12px;
  font-size: 0.9rem;
  opacity: 0.8;
  line-height: 1.4;
}

/* 模块内标签字体放大 */
.communication-label,
.appearance-label,
.ratio-label,
.tarot-count-label,
.max-count-label,
.auto-send-label {
  font-size: 0.95rem;
  font-weight: 500;
  margin-bottom: 6px;
  color: var(--text);
}

/* 输入框字体放大 */
.phrases-textarea,
.tarot-textarea,
.cloud-textarea,
.appearance-input,
.date-input,
.message-input,
.max-count-select,
.auto-send-select {
  font-size: 0.9rem;
  padding: 10px 12px;
}

/* 按钮字体放大 */
.add-sticker-btn,
.save-phrases-btn,
.export-btn,
.communication-btn,
.cloud-btn,
.save-background-btn,
.save-tarot-btn,
.format-btn,
.background-upload-btn,
.remove-background-btn,
.modal-btn.primary,
#saveMusicSettingsBtn,
.call-button,
.video-button {
  font-size: 0.95rem;
  padding: 12px;
}

/* 预设按钮字体 */
.preset-btn {
  font-size: 0.85rem;
  padding: 8px;
}

/* 表情包库区域 */
.sticker-preview {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 15px;
  max-height: 200px;
  overflow-y: auto;
  padding: 4px;
}

.sticker-item {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px dashed rgba(92, 92, 92, 0.2);
  position: relative;
}

.sticker-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.sticker-placeholder {
  font-size: 1.2rem;
  color: rgba(92, 92, 92, 0.3);
}

.delete-sticker {
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}

.sticker-item:hover .delete-sticker {
  opacity: 1;
}

/* 所有设置按钮 */
.add-sticker-btn,
.save-phrases-btn,
.export-btn,
.communication-btn,
.cloud-btn,
.save-background-btn,
.save-tarot-btn,
.format-btn,
.background-upload-btn,
.remove-background-btn,
.modal-btn.primary,
#saveMusicSettingsBtn {
  display: block;
  width: 100%;
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 10px;
}

.add-sticker-btn:hover,
.save-phrases-btn:hover,
.export-btn:hover,
.communication-btn:hover,
.cloud-btn:hover,
.save-background-btn:hover,
.save-tarot-btn:hover,
.format-btn:hover,
.background-upload-btn:hover,
.remove-background-btn:hover,
.modal-btn.primary:hover,
#saveMusicSettingsBtn:hover {
  background: var(--accent-gray-light);
}

/* 字卡管理区域 */
.phrases-textarea {
  width: 100%;
  height: 150px;
  padding: 10px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.8rem;
  line-height: 1.3;
  resize: vertical;
  margin-bottom: 10px;
  box-sizing: border-box;
}

.phrases-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.phrases-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  font-size: 0.8rem;
  color: rgba(92, 92, 92, 0.7);
}

/* 比例设置区域 */
.ratio-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
}

.ratio-item {
  margin-bottom: 12px;
}

.ratio-item:last-child {
  margin-bottom: 0;
}

.ratio-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
  font-size: 0.8rem;
}

.ratio-slider {
  width: 100%;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: rgba(92, 92, 92, 0.2);
  border-radius: 3px;
  outline: none;
}

.ratio-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.ratio-slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.ratio-value {
  font-weight: 500;
  color: var(--accent);
}

.max-count-control,
.auto-send-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 15px;
  padding-top: 12px;
  border-top: 1px solid rgba(92, 92, 92, 0.1);
}

.max-count-label,
.auto-send-label {
  font-size: 0.85rem;
}

.max-count-select,
.auto-send-select {
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  background: rgba(255, 255, 255, 0.7);
  color: var(--text);
  font-size: 0.8rem;
  outline: none;
  width: 65px;
}

/* 外观设置区域 */
.appearance-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
}

.appearance-item {
  margin-bottom: 12px;
}

.appearance-item:last-child {
  margin-bottom: 0;
}

.appearance-label {
  display: block;
  margin-bottom: 4px;
  font-size: 0.8rem;
  color: var(--text);
}

.appearance-input {
  width: 100%;
  padding: 6px 10px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.8rem;
  color: var(--text);
  outline: none;
  box-sizing: border-box;
}

.appearance-input:focus {
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.date-inputs {
  display: flex;
  gap: 6px;
  align-items: center;
}

.date-input {
  flex: 1;
  padding: 6px 8px;
  border: 1px solid rgba(92, 92, 92, 0.3);
  border-radius: 6px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.8rem;
  color: var(--text);
  outline: none;
}

.date-input:focus {
  border-color: var(--accent);
}

/* 导出设置区域 */
.export-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
}

.export-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 12px;
}

.export-option {
  display: flex;
  align-items: center;
  gap: 6px;
}

.export-option input[type="checkbox"] {
  width: 16px;
  height: 16px;
  accent-color: var(--accent);
}

.export-option label {
  font-size: 0.85rem;
  color: var(--text);
}

.export-formats {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.format-btn {
  flex: 1;
  padding: 8px;
  border: 1px solid var(--accent-gray);
  border-radius: 6px;
  background: var(--accent-gray);
  color: white;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
}

.format-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  border-color: var(--accent-gray-light);
}

/* 通信设置区域 */
.communication-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
}

.communication-item {
  margin-bottom: 15px;
}

.communication-item:last-child {
  margin-bottom: 0;
}

.communication-label {
  display: block;
  margin-bottom: 6px;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text);
}

.communication-buttons {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.call-button, .video-button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  background: #000000;
  color: #ffffff;
  border: 2px solid #000000;
  font-weight: 500;
}

.call-button:hover, .video-button:hover {
  background: #333333;
  color: #ffffff;
  border-color: #333333;
  transform: translateY(-1px);
}

.communication-stats {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 6px;
  padding: 10px;
  margin-top: 12px;
  font-size: 0.8rem;
}

.communication-stats p {
  margin: 4px 0;
}

/* 主动呼叫设置区域 */
.active-call-controls {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
  border-left: 4px solid var(--accent);
}

.active-call-item {
  margin-bottom: 12px;
}

.active-call-item:last-child {
  margin-bottom: 0;
}

.active-call-slider {
  width: 100%;
  height: 5px;
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(to right, #ccc, var(--accent));
  border-radius: 3px;
  outline: none;
  margin-top: 6px;
}

.active-call-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

.active-call-slider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid white;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

.active-call-value {
  font-weight: 600;
  color: var(--accent);
  font-size: 0.9rem;
}

.active-call-preview {
  background: rgba(138, 127, 141, 0.1);
  border-radius: 6px;
  padding: 10px;
  margin-top: 12px;
  font-size: 0.8rem;
  line-height: 1.4;
}

.active-call-preview p {
  margin: 3px 0;
}

/* 预设模式按钮 */
.preset-buttons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  margin-top: 8px;
}

.preset-btn {
  padding: 6px;
  border: 1px solid var(--accent-gray);
  border-radius: 6px;
  background: white;
  color: var(--text);
  font-size: 0.75rem;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.preset-btn:hover {
  background: var(--accent-gray-light);
  color: white;
  border-color: var(--accent-gray-light);
}

.preset-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* 云导入区域 */
.cloud-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
}

.cloud-item {
  margin-bottom: 12px;
}

.cloud-item:last-child {
  margin-bottom: 0;
}

.cloud-textarea {
  width: 100%;
  height: 100px;
  padding: 10px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.8rem;
  line-height: 1.3;
  resize: vertical;
  margin-bottom: 8px;
  box-sizing: border-box;
  font-family: monospace;
}

.cloud-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.9);
}

.cloud-info {
  font-size: 0.75rem;
  color: rgba(92, 92, 92, 0.7);
  margin-top: 8px;
}

/* 背景设置区域 */
.background-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
}

.background-item {
  margin-bottom: 12px;
}

.background-item:last-child {
  margin-bottom: 0;
}

.background-preview {
  width: 100%;
  height: 120px;
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 8px;
  border: 2px dashed rgba(92, 92, 92, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  background-size: cover;
  background-position: center;
  position: relative;
}

.background-preview.empty {
  background: rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 4px;
}

.background-preview.empty i {
  font-size: 1.5rem;
  color: rgba(92, 92, 92, 0.3);
}

.background-preview.empty span {
  font-size: 0.8rem;
  color: rgba(92, 92, 92, 0.5);
}

.background-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 12px;
}

.background-option {
  width: 100%;
  height: 50px;
  border-radius: 6px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.background-option:hover {
  transform: scale(1.01);
}

.background-option.active {
  border-color: var(--accent);
}

.background-option img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.background-option.color {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  color: white;
  font-weight: 500;
  background: #f5f5f5;
  color: var(--text);
}

.background-option.color span {
  position: relative;
  z-index: 2;
}

.background-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.background-upload-btn {
  flex: 1;
}

.remove-background-btn {
  background: var(--accent-gray);
  color: white;
  border: none;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 100%;
  margin-top: 8px;
}

.remove-background-btn:hover {
  background: var(--accent-gray-light);
}

/* 塔罗牌设置区域 */
.tarot-controls {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 15px;
}

.tarot-item {
  margin-bottom: 12px;
}

.tarot-item:last-child {
  margin-bottom: 0;
}

.tarot-switch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
  padding: 8px;
  background: var(--tarot-bg);
  border-radius: 8px;
  border-left: 4px solid var(--tarot-text);
}

.tarot-switch-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  color: var(--tarot-text);
  font-size: 0.85rem;
}

.tarot-switch-label i {
  font-size: 1.1rem;
}

.tarot-count-control {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.tarot-count-label {
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text);
}

.tarot-number-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-bottom: 12px;
}

.tarot-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.85rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.tarot-number:hover {
  background: rgba(138, 127, 141, 0.2);
}

.tarot-number.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent-light);
}

.tarot-textarea {
  width: 100%;
  height: 150px;
  padding: 10px;
  border: 1px solid rgba(92, 92, 92, 0.2);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.7);
  font-size: 0.8rem;
  line-height: 1.3;
  resize: vertical;
  margin-bottom: 8px;
  box-sizing: border-box;
}

.tarot-textarea:focus {
  outline: none;
  border-color: var(--tarot-text);
  background: rgba(255, 255, 255, 0.9);
}

.tarot-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  font-size: 0.8rem;
  color: rgba(92, 92, 92, 0.7);
}

.tarot-status {
  padding: 6px 10px;
  background: var(--tarot-bg);
  border-radius: 6px;
  font-size: 0.8rem;
  color: var(--tarot-text);
  margin-top: 12px;
  border-left: 3px solid var(--tarot-text);
}

/* 隐藏的文件输入 */
.hidden-file-input {
  display: none;
}

/* 滚动条样式 */
::-webkit-scrollbar {
  width: 4px;
}

::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.05);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: rgba(92, 92, 92, 0.3);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(92, 92, 92, 0.5);
}

/* 响应式设计 - 移动端优化 */
@media (max-width: 768px) {
  .container {
    height: 95vh;
    padding: 8px;
    gap: 8px;
  }
  
  .chat-header {
    padding: 3px 0;
  }
  
  .chat-title-area h1 {
    font-size: 1rem;
  }
  
  .chat-subtitle {
    font-size: 0.6rem;
    padding: 3px 8px;
  }
  
  .user-info {
    width: 55px;
    margin-top: 8px;
  }
  
  .avatar {
    width: 38px;
    height: 38px;
  }
  
  .status-indicator {
    right: 6px;
    width: 7px;
    height: 7px;
  }
  
  #otherUserInfo .status-indicator,
  #selfUserInfo .status-indicator {
    top: 35px;
  }
  
  .nickname {
    font-size: 0.65rem;
    padding: 3px 8px;
  }
  
  .right-buttons {
    gap: 4px;
  }
  
  .theme-toggle,
  .settings-toggle {
    width: 28px;
    height: 28px;
  }
  
  .theme-toggle i,
  .settings-toggle i {
    font-size: 0.9rem;
  }
  
  .message-input {
    min-width: 80px;
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  
  .send-button {
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  
  .continue-button,
  .upload-image-button {
    width: 34px;
    height: 34px;
  }
  
  .date-inputs {
    flex-direction: column;
  }
  
  .communication-buttons {
    flex-direction: column;
  }
  
  .input-area-buttons {
    flex-wrap: wrap;
  }
  
  .background-options {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .tarot-number-selector {
    justify-content: center;
  }
  
  .message-actions {
    top: -40px;
  }
  
  .message-action-btn {
    padding: 6px 8px;
    font-size: 0.7rem;
  }
  
  .preset-buttons {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .love-days {
    font-size: 0.6rem;
    padding: 3px 8px;
  }
}

/* 遮罩层 */
.settings-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(2px);
  z-index: 999;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.settings-overlay.active {
  opacity: 1;
  visibility: visible;
}

/* 通知样式 */
.notification {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: var(--accent);
  color: white;
  padding: 8px 14px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  animation: fadeInOut 3s ease;
  font-size: 0.8rem;
  max-width: 250px;
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(10px); }
}

/* 通话/视频小窗口 */
.call-window, .video-window {
  position: fixed;
  width: 35mm;
  height: 35mm;
  min-width: 160px;
  min-height: 120px;
  max-width: 85vw;
  max-height: 85vh;
  background: var(--bg-panel);
  backdrop-filter: blur(8px);
  border-radius: 10px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  resize: both;
  cursor: move;
  border: 1px solid rgba(92, 92, 92, 0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  touch-action: none;
}

.call-window:hover, .video-window:hover {
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
}

.call-window {
  border-top: 4px solid #000000;
}

.video-window {
  border-top: 4px solid #000000;
}

.call-window.active, .video-window.active {
  transform: scale(1.01);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
}

.window-header {
  padding: 8px 10px;
  background: rgba(255, 255, 255, 0.9);
  border-bottom: 1px solid rgba(92, 92, 92, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: move;
  touch-action: none;
}

.window-title {
  font-size: 0.85rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 4px;
}

.window-title i {
  font-size: 0.9rem;
}

.call-window .window-title {
  color: #000000;
}

.video-window .window-title {
  color: #000000;
}

.window-controls {
  display: flex;
  gap: 4px;
}

.window-btn {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: none;
  background: rgba(92, 92, 92, 0.1);
  color: var(--text);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s;
  touch-action: manipulation;
}

.window-btn:hover {
  background: rgba(92, 92, 92, 0.2);
}

.window-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 12px;
}

.call-avatar, .video-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  overflow: hidden;
  margin-bottom: 8px;
  border: 2px solid;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

.call-avatar {
  border-color: #000000;
}

.video-avatar {
  border-color: #000000;
}

.call-avatar img, .video-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.calling-text {
  font-size: 0.75rem;
  color: var(--text);
  margin-bottom: 8px;
  text-align: center;
}

.in-call-text {
  font-size: 0.7rem;
  color: #333;
  background: rgba(0, 0, 0, 0.05);
  padding: 3px 6px;
  border-radius: 4px;
  margin-bottom: 8px;
  font-weight: 500;
}

.call-timer {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
  font-family: monospace;
}

.call-buttons {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}

.accept-btn, .reject-btn, .end-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 16px;
  font-size: 0.75rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
  min-width: 60px;
  touch-action: manipulation;
}

.accept-btn {
  background: var(--online);
  color: white;
}

.accept-btn:hover {
  background: #3d8b40;
}

.reject-btn {
  background: #f44336;
  color: white;
}

.reject-btn:hover {
  background: #d32f2f;
}

.end-btn {
  background: #f44336;
  color: white;
}

.end-btn:hover {
  background: #d32f2f;
}

/* 通话记录消息样式 */
.call-message, .video-message {
  background: rgba(0, 0, 0, 0.1);
  border-left: 3px solid #000000;
  color: #000000;
}

.video-message {
  background: rgba(0, 0, 0, 0.1);
  border-left: 3px solid #000000;
  color: #000000;
}

/* 塔罗牌消息样式 */
.tarot-message {
  background: var(--tarot-bg);
  border-left: 3px solid var(--tarot-text);
  color: var(--tarot-text);
}

/* 设置图标字体 */
@font-face {
  font-family: 'Material Icons';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/materialicons/v139/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');
}

.material-icons {
  font-family: 'Material Icons';
  font-weight: normal;
  font-style: normal;
  font-size: 18px;
  line-height: 1;
  letter-spacing: normal;
  text-transform: none;
  display: inline-block;
  white-space: nowrap;
  word-wrap: normal;
  direction: ltr;
  -webkit-font-feature-settings: 'liga';
  -webkit-font-smoothing: antialiased;
}

/* 昵称编辑框 */
.nickname-input {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--accent);
  color: var(--text);
  font-size: 0.8rem;
  text-align: center;
  width: 100%;
  outline: none;
  padding: 2px 0;
}

/* 模态框样式 */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(3px);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--bg-panel);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  padding: 20px;
  width: 90%;
  max-width: 320px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

.modal-title {
  margin-top: 0;
  margin-bottom: 12px;
  color: var(--accent);
  font-weight: 400;
  text-align: center;
  font-size: 1.2rem;
}

.avatar-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  overflow: hidden;
  margin: 0 auto 12px;
  border: 2px solid var(--accent);
  background-color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.modal-buttons {
  display: flex;
  gap: 6px;
  margin-top: 12px;
}

.modal-btn {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.modal-btn.primary {
  background: var(--accent-gray);
  color: white;
}

.modal-btn.secondary {
  background: rgba(92, 92, 92, 0.1);
  color: var(--text);
}

.modal-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* 开关样式 */
.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 22px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 22px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: var(--tarot-text);
}

input:checked + .slider:before {
  transform: translateX(22px);
}

/* ===== 音乐播放器小窗样式 ===== */
.music-window {
  position: fixed;
  width: 320px;
  height: 180px;
  background: rgba(245, 245, 245, 0.95);
  backdrop-filter: blur(15px);
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  z-index: 2000;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  resize: none;
  cursor: move;
  border: 1px solid rgba(255, 255, 255, 0.3);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  touch-action: none;
  border-top: 4px solid #a99cad;
}

.music-window:hover {
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
  transform: scale(1.01);
}

.music-window .window-header {
  background: rgba(255, 255, 255, 0.7);
  border-bottom: 1px solid rgba(138, 127, 141, 0.2);
  padding: 6px 10px;
}

.music-window .window-title {
  color: #8a7f8d;
  font-weight: 500;
  font-size: 0.8rem;
}

/* CD唱片容器 */
.music-cd-container {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  gap: 12px;
  flex: 1;
}

/* CD唱片 */
.music-cd {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(45deg, #2c3e50, #3498db);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  position: relative;
  flex-shrink: 0;
  animation: cdSpin 8s linear infinite;
  animation-play-state: paused;
  cursor: pointer;
  transition: all 0.3s ease;
}

.music-cd.playing {
  animation-play-state: running;
}

.music-cd::before {
  content: '';
  position: absolute;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  border: 2px dashed rgba(255,255,255,0.5);
}

.music-cd::after {
  content: '';
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: rgba(255,255,255,0.8);
  box-shadow: 0 0 8px rgba(255,255,255,0.8);
}

.music-cd img {
  width: 60%;
  height: 60%;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid rgba(255,255,255,0.5);
}

@keyframes cdSpin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* 音乐信息 */
.music-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.music-title {
  font-size: 0.9rem;
  font-weight: 600;
  color: #5c5c5c;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}

.music-artist {
  font-size: 0.7rem;
  color: #888;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* 进度条 */
.music-progress-container {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.music-progress-bar {
  width: 100%;
  height: 5px;
  background: rgba(0,0,0,0.1);
  border-radius: 3px;
  position: relative;
  cursor: pointer;
}

.music-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #a99cad, #8a7f8d);
  border-radius: 3px;
  width: 0%;
  position: relative;
  transition: width 0.1s linear;
}

.music-progress-handle {
  width: 12px;
  height: 12px;
  background: white;
  border: 2px solid #8a7f8d;
  border-radius: 50%;
  position: absolute;
  right: -6px;
  top: -3px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  opacity: 0;
  transition: opacity 0.2s;
}

.music-progress-bar:hover .music-progress-handle {
  opacity: 1;
}

/* 时间显示 */
.music-time {
  display: flex;
  justify-content: space-between;
  font-size: 0.65rem;
  color: #666;
}

/* 控制按钮 */
.music-controls-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 2px;
}

.music-control-btn {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: none;
  background: rgba(138, 127, 141, 0.1);
  color: #5c5c5c;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.music-control-btn:hover {
  background: #8a7f8d;
  color: white;
  transform: scale(1.1);
}

.music-control-btn i {
  font-size: 1rem;
}

/* 音乐库列表样式 */
.music-list {
  max-height: 200px;
  overflow-y: auto;
  border-radius: 8px;
  background: rgba(255,255,255,0.5);
  padding: 6px;
}

.music-item-card {
  display: flex;
  align-items: center;
  padding: 8px;
  border-radius: 8px;
  background: white;
  margin-bottom: 4px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  transition: all 0.2s;
}

.music-item-card:hover {
  background: rgba(138, 127, 141, 0.1);
  transform: translateY(-1px);
}

.music-item-icon {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  background: linear-gradient(135deg, #a99cad, #8a7f8d);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 8px;
  color: white;
}

.music-item-info {
  flex: 1;
  overflow: hidden;
}

.music-item-name {
  font-size: 0.8rem;
  font-weight: 500;
  color: #5c5c5c;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.music-item-size {
  font-size: 0.6rem;
  color: #888;
}

.music-item-actions {
  display: flex;
  gap: 6px;
}

.music-item-play {
  padding: 4px 8px;
  border: none;
  border-radius: 12px;
  background: #8a7f8d;
  color: white;
  font-size: 0.65rem;
  cursor: pointer;
  transition: all 0.2s;
}

.music-item-delete {
  padding: 4px;
  border: none;
  border-radius: 50%;
  background: rgba(244, 67, 54, 0.1);
  color: #f44336;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.music-item-delete:hover {
  background: #f44336;
  color: white;
}

.music-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  color: #888;
  gap: 6px;
}

.music-upload-area {
  width: 100%;
  height: 100px;
  border: 2px dashed #bdbdbd;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 12px;
  background: rgba(255,255,255,0.5);
}

.music-upload-area:hover {
  border-color: #8a7f8d;
  background: rgba(138, 127, 141, 0.1);
}

@media (max-width: 768px) {
  .music-window {
    width: 280px;
    height: 160px;
  }
  
  .music-cd {
    width: 65px;
    height: 65px;
  }
  
  .music-window .window-content {
    padding: 8px;
  }
  
  .call-window, .video-window {
    width: 60mm;
    height: 80mm;
  }
  
  .call-window .call-buttons,
  .video-window .call-buttons {
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }
  
  .accept-btn, .reject-btn, .end-btn {
    width: 100%;
    padding: 10px;
    font-size: 0.8rem;
  }
}
</style>
</head>
<body>
<!-- 背景图片容器 - 确保完全覆盖 -->
<div class="background-container" id="backgroundContainer"></div>

<div class="container">
  <!-- 设置遮罩层 -->
  <div class="settings-overlay" id="settingsOverlay"></div>
  
  <!-- 用户信息编辑模态框 -->
  <div class="modal-overlay" id="userModal">
    <div class="modal-content">
      <h3 class="modal-title" id="modalTitle">编辑用户信息</h3>
      
      <div class="avatar-preview" id="avatarPreview">
        <!-- 头像预览 -->
      </div>
      
      <div style="margin-bottom: 12px;">
        <label style="display:block; margin-bottom:4px; color:var(--text); font-size:0.8rem;">昵称:</label>
        <input type="text" class="nickname-input" id="modalNicknameInput" maxlength="12" style="width:100%; padding:6px; border-radius:6px; border:1px solid rgba(92,92,92,0.3); font-size:0.8rem;">
      </div>
      
      <div style="margin-bottom: 12px;">
        <label style="display:block; margin-bottom:4px; color:var(--text); font-size:0.8rem;">更换头像:</label>
        <input type="file" id="modalAvatarUpload" class="hidden-file-input" accept="image/*">
        <button class="add-sticker-btn" id="uploadAvatarBtn" style="margin-bottom:0; padding:8px; font-size:0.8rem;">选择头像图片</button>
      </div>
      
      <div class="modal-buttons">
        <button class="modal-btn secondary" id="cancelEditBtn">取消</button>
        <button class="modal-btn primary" id="saveUserInfoBtn">保存</button>
      </div>
    </div>
  </div>
  
  <!-- 聊天头部 - 新布局 -->
  <div class="chat-header">
    <!-- 左侧用户信息（对方） -->
    <div class="user-info" id="otherUserInfo">
      <div class="avatar" id="otherAvatar">
        <!-- 白色圆形，无文字无默认图片 -->
      </div>
      <div class="nickname" id="otherNickname">对方</div>
    </div>
    
    <!-- 中间标题 -->
    <div class="chat-title-area">
      <h1 id="appTitle">梦角爱人</h1>
      <div class="chat-subtitle" id="appSubtitle">绝对私密的一对一聊天空间</div>
    </div>
    
    <!-- 右侧用户信息（自己）- 移到原本夜间模式位置 -->
    <div class="user-info" id="selfUserInfo">
      <div class="avatar" id="selfAvatar">
        <!-- 白色圆形，无文字无默认图片 -->
      </div>
      <div class="status-text" id="selfStatusText">在线</div>
      <div class="nickname" id="selfNickname">我</div>
    </div>
    
    <!-- 右侧按钮组 - 夜间模式移到设置按钮上方 -->
    <div class="right-buttons">
      <div class="theme-toggle" id="themeToggle">
        <i class="material-icons">dark_mode</i>
      </div>
      <div class="settings-toggle" id="settingsToggle">
        <i class="material-icons">settings</i>
      </div>
    </div>
  </div>
  
  <!-- 聊天区域 -->
  <section class="chat-section">
    <div class="chat-container">
      <div class="messages-area" id="messagesArea">
        <!-- 对方正在输入指示器 -->
        <div class="typing-indicator" id="typingIndicator">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
          <span style="font-size:0.7rem; margin-left:4px;">对方正在输入...</span>
        </div>
        
        <!-- 初始消息将从本地存储加载 -->
      </div>
      
      <div class="input-area">
        <div class="input-area-buttons">
          <input type="text" class="message-input" id="messageInput" placeholder="输入消息..." maxlength="200">
          <div class="upload-image-button" id="uploadImageButton" title="发送图片">
            <i class="material-icons">image</i>
          </div>
          <input type="file" id="imageUpload" class="hidden-file-input" accept="image/*">
          <button class="continue-button" id="continueButton">...</button>
          <button class="send-button" id="sendButton">发送</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- 设置面板 -->
<div class="settings-panel" id="settingsPanel">
  <div class="settings-header">
    <h2>设置</h2>
    <div class="settings-header-right">
      <!-- 恋爱天数移到设置面板顶部右侧 -->
      <div class="love-days" id="loveDaysDisplay">
        <i class="material-icons">favorite</i>
        <span>恋爱 <span id="loveDaysCount">1</span> 天</span>
      </div>
      <button class="close-settings" id="closeSettings">
        <i class="material-icons">close</i>
      </button>
    </div>
  </div>
  
  <!-- 设置标签栏 -->
  <div class="settings-tabs">
    <button class="tab-button active" data-tab="stickers">表情包库</button>
    <button class="tab-button" data-tab="phrases">回复词条</button>
    <button class="tab-button" data-tab="tarot">塔罗牌</button>
    <button class="tab-button" data-tab="ratio">发送设置</button>
    <button class="tab-button" data-tab="appearance">外观设置</button>
    <button class="tab-button" data-tab="background">背景设置</button>
    <button class="tab-button" data-tab="communication">通话视频</button>
    <button class="tab-button" data-tab="music">🎵 音乐播放</button>
    <button class="tab-button" data-tab="cloud">云导入</button>
    <button class="tab-button" data-tab="export">导出记录</button>
  </div>
  
  <div class="settings-content">
    <!-- 表情包库标签页 -->
    <div class="tab-content active" id="stickersTab">
      <div class="sticker-library">
        <h3>表情包库管理</h3>
        <p>添加图片后，对方可以随机发送这些表情包作为回复</p>
        
        <div class="sticker-preview" id="stickerPreview">
          <!-- 表情包将在这里显示 -->
          <div class="sticker-item" id="addStickerPlaceholder">
            <div class="sticker-placeholder">+</div>
          </div>
        </div>
        
        <input type="file" id="stickerUpload" class="hidden-file-input" accept="image/*" multiple>
        <button class="add-sticker-btn" id="addStickerBtn">从相册添加表情包</button>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：点击表情包右上角的×可以删除。已添加 <span id="stickerCount">0</span> 个表情包
        </p>
      </div>
    </div>
    
    <!-- 回复词条标签页 -->
    <div class="tab-content" id="phrasesTab">
      <div class="phrases-library">
        <h3>回复词条管理</h3>
        <p style="margin-bottom: 6px;">对方将从这些词条中随机抽取作为回复。每行一个词条，自动识别分行。</p>
        <p style="font-size:0.7rem; color:#888; margin-bottom: 12px;">提示：点击任意消息可以引用or删除or撤回</p>
        
        <textarea class="phrases-textarea" id="phrasesTextarea" placeholder="请输入回复词条，每行一个&#10;例如：&#10;好的，明白了&#10;这很有趣&#10;继续聊吧&#10;让我想想"></textarea>
        
        <div class="phrases-info">
          <span>当前词条数: <span id="phraseCount">0</span></span>
          <span>随机混合表情包和字卡发送</span>
        </div>
        
        <button class="save-phrases-btn" id="savePhrasesBtn">保存词条</button>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：保存后，对方将从这些词条和表情包中随机选择，随机混合发送<br>
          （塔罗牌模式开启时，将优先使用塔罗牌字卡）
        </p>
      </div>
    </div>
    
    <!-- 塔罗牌标签页 -->
    <div class="tab-content" id="tarotTab">
      <div class="tarot-library">
        <h3>塔罗牌字卡抽取 🔮</h3>
        <p>开启塔罗牌梦占模式，对方将只抽取塔罗牌字卡进行回复</p>
        
        <div class="tarot-controls">
          <div class="tarot-switch">
            <div class="tarot-switch-label">
              <i class="material-icons">auto_awesome</i>
              <span>塔罗牌梦占模式</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="tarotModeToggle">
              <span class="slider"></span>
            </label>
          </div>
          
          <div class="tarot-item">
            <div class="tarot-count-control">
              <div class="tarot-count-label">每次抽取数量:</div>
              <div id="tarotCountValue">1</div>
            </div>
            
            <div class="tarot-number-selector" id="tarotNumberSelector">
              <!-- 数字1-15将通过JS动态生成 -->
            </div>
          </div>
          
          <div class="tarot-item">
            <label class="communication-label">塔罗牌字卡库:</label>
            <textarea class="tarot-textarea" id="tarotTextarea" placeholder="请输入塔罗牌字卡，每行一个&#10;例如：&#10;愚人 正位&#10;魔术师 逆位&#10;女祭司 正位&#10;世界 逆位"></textarea>
            
            <div class="tarot-info">
              <span>当前塔罗牌字卡数: <span id="tarotPhraseCount">0</span></span>
              <span>每行一个字卡</span>
            </div>
          </div>
          
          <button class="save-tarot-btn" id="saveTarotBtn">保存塔罗牌设置</button>
          
          <div class="tarot-status" id="tarotStatus">
            塔罗牌模式已关闭，对方使用普通词条和表情包回复
          </div>
          
          <!-- 塔罗牌操作按钮 -->
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            <button class="cloud-btn" id="loadDefaultTarotBtn" style="flex: 1; padding: 8px;">加载默认78张塔罗牌</button>
            <button class="cloud-btn" id="clearTarotBtn" style="flex: 1; padding: 8px; background: #888;">清空塔罗牌库</button>
          </div>
          
          <div style="margin-top: 12px; padding: 10px; background: rgba(255, 255, 255, 0.5); border-radius: 6px; border-left: 3px solid var(--tarot-text);">
            <p style="margin: 0 0 6px 0; font-size: 0.8rem; font-weight: 500; color: var(--tarot-text);">抽取规则说明：</p>
            <p style="margin: 3px 0; font-size: 0.7rem; color: #666;">
              • 智能识别牌名：支持"愚人 正位"、"正位·魔术师"、"逆位-女祭司"等多种格式
            </p>
            <p style="margin: 3px 0; font-size: 0.7rem; color: #666;">
              • 同牌正逆位不重复：抽到"愚人 正位"后，不会再抽"愚人 逆位"
            </p>
          </div>
        </div>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：开启塔罗牌模式后，对方回复将只从塔罗牌字卡库中抽取<br>
          可以设置每次抽取1-15张塔罗牌字卡<br>
          <strong>智能规则：同牌正逆位不重复抽取</strong>
        </p>
      </div>
    </div>
    
    <!-- 发送设置标签页 -->
    <div class="tab-content" id="ratioTab">
      <div class="ratio-library">
        <h3>发送设置</h3>
        <p>调整对方回复时表情包和字卡的发送比例</p>
        
        <div class="ratio-controls">
          <div class="ratio-item">
            <div class="ratio-label">
              <span>表情包发送比例</span>
              <span class="ratio-value" id="stickerRatioValue">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="ratio-slider" id="stickerRatioSlider">
          </div>
          
          <div class="ratio-item">
            <div class="ratio-label">
              <span>字卡发送比例</span>
              <span class="ratio-value" id="phraseRatioValue">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" class="ratio-slider" id="phraseRatioSlider">
          </div>
          
          <div class="max-count-control">
            <div class="max-count-label">最大发送数量:</div>
            <select class="max-count-select" id="maxMessageCount">
              <option value="1">1条</option>
              <option value="2">2条</option>
              <option value="3" selected>3条</option>
              <option value="4">4条</option>
              <option value="5">5条</option>
            </select>
          </div>
          
          <div class="auto-send-controls">
            <div class="auto-send-label">主动发送频率:</div>
            <select class="auto-send-select" id="autoSendFrequency">
              <option value="0">不主动发送</option>
              <option value="300000">5分钟</option>
              <option value="600000" selected>10分钟</option>
              <option value="1200000">20分钟</option>
              <option value="1800000">30分钟</option>
              <option value="3600000">1小时</option>
            </select>
          </div>
        </div>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：对方回复时会根据此比例随机混合发送表情包和字卡<br>
          对方也会根据设置的频率主动发送消息<br>
          （塔罗牌模式开启时，将忽略此比例设置，只抽取塔罗牌字卡）
        </p>
      </div>
    </div>
    
    <!-- 外观设置标签页 -->
    <div class="tab-content" id="appearanceTab">
      <div class="appearance-library">
        <h3>外观设置</h3>
        <p>自定义聊天界面的外观和显示信息</p>
        
        <div class="appearance-controls">
          <div class="appearance-item">
            <label class="appearance-label">应用标题:</label>
            <input type="text" class="appearance-input" id="appTitleInput" value="梦角爱人" maxlength="20">
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">应用副标题:</label>
            <input type="text" class="appearance-input" id="appSubtitleInput" value="绝对私密的一对一聊天空间" maxlength="50">
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">恋爱起始日期:</label>
            <div class="date-inputs">
              <input type="number" class="date-input" id="loveYear" placeholder="年" min="2000" max="2100" value="2024">
              <input type="number" class="date-input" id="loveMonth" placeholder="月" min="1" max="12" value="1">
              <input type="number" class="date-input" id="loveDay" placeholder="日" min="1" max="31" value="1">
            </div>
          </div>
          
          <div class="appearance-item">
            <label class="appearance-label">对方心情变化频率:</label>
            <select class="appearance-input" id="moodChangeFrequency">
              <option value="60000">1分钟</option>
              <option value="300000">5分钟</option>
              <option value="600000" selected>10分钟</option>
              <option value="1200000">20分钟</option>
              <option value="1800000">30分钟</option>
            </select>
          </div>
        </div>
        
        <button class="save-phrases-btn" id="saveAppearanceBtn">保存外观设置</button>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：保存后，应用标题、副标题和恋爱天数将立即更新
        </p>
      </div>
    </div>
    
    <!-- 背景设置标签页 -->
    <div class="tab-content" id="backgroundTab">
      <div class="background-library">
        <h3>背景设置</h3>
        <p>自定义聊天背景，可以选择预设背景或上传自己的图片</p>
        
        <div class="background-controls">
          <div class="background-item">
            <label class="communication-label">当前背景预览:</label>
            <div class="background-preview" id="backgroundPreview">
              <div class="empty">
                <i class="material-icons">wallpaper</i>
                <span>默认背景</span>
              </div>
            </div>
          </div>
          
          <div class="background-item">
            <label class="communication-label">上传背景图片:</label>
            <div class="background-options">
              <div class="background-option color" id="uploadBackgroundOption">
                <span>点击上传背景图片</span>
              </div>
            </div>
            <input type="file" id="backgroundUpload" class="hidden-file-input" accept="image/*">
          </div>
          
          <div class="background-item">
            <label class="communication-label">背景透明度:</label>
            <input type="range" min="0" max="100" value="100" class="ratio-slider" id="backgroundOpacitySlider">
            <div style="display:flex; justify-content:space-between; margin-top:6px;">
              <span style="font-size:0.75rem;">透明</span>
              <span style="font-size:0.75rem;" id="backgroundOpacityValue">100%</span>
              <span style="font-size:0.75rem;">不透明</span>
            </div>
          </div>
          
          <button class="remove-background-btn" id="removeBackgroundBtn">恢复默认背景</button>
        </div>
        
        <button class="save-background-btn" id="saveBackgroundBtn">保存背景设置</button>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：上传的图片会保存在本地，刷新页面不会丢失
        </p>
      </div>
    </div>
    
    <!-- 通信设置标签页 -->
    <div class="tab-content" id="communicationTab">
      <div class="communication-library">
        <h3>通话与视频</h3>
        <p>模拟通话和视频功能，对方可以主动邀请或响应用户的邀请</p>
        
        <div class="communication-controls">
          <div class="communication-item">
            <div class="communication-label">主动呼叫对方</div>
            <div class="communication-buttons">
              <button class="call-button" id="startCallButton">
                <i class="material-icons">call</i>
                语音通话
              </button>
              <button class="video-button" id="startVideoButton">
                <i class="material-icons">videocam</i>
                视频通话
              </button>
            </div>
          </div>
          
          <div class="communication-item">
            <div class="communication-label">通话设置</div>
            <div style="margin-top: 8px;">
              <label style="display:flex; align-items:center; gap:6px; font-size:0.8rem; margin-bottom:6px;">
                <input type="checkbox" id="autoAcceptCalls" checked>
                <span>自动接听对方来电</span>
              </label>
              <label style="display:flex; align-items:center; gap:6px; font-size:0.8rem;">
                <input type="checkbox" id="autoAcceptVideos" checked>
                <span>自动接听对方视频邀请</span>
              </label>
            </div>
          </div>
          
          <!-- 主动呼叫设置 -->
          <div class="active-call-controls">
            <div class="communication-label">对方主动呼叫设置</div>
            
            <div class="active-call-item">
              <div class="ratio-label">
                <span>总体呼叫频率</span>
                <span class="active-call-value" id="overallFrequencyValue">30%</span>
              </div>
              <input type="range" min="0" max="100" value="30" class="active-call-slider" id="overallFrequencySlider">
              <div style="display:flex; justify-content:space-between; margin-top:2px;">
                <span style="font-size:0.7rem; color:#888;">关闭</span>
                <span style="font-size:0.7rem; color:#888;">最高</span>
              </div>
            </div>
            
            <div class="active-call-item">
              <div class="ratio-label">
                <span>呼叫类型偏好</span>
                <span class="active-call-value" id="callPreferenceValue">电话 50% / 视频 50%</span>
              </div>
              <input type="range" min="0" max="100" value="50" class="active-call-slider" id="callPreferenceSlider">
              <div style="display:flex; justify-content:space-between; margin-top:2px;">
                <span style="font-size:0.7rem; color:#888;">纯电话</span>
                <span style="font-size:0.7rem; color:#888;">纯视频</span>
              </div>
            </div>
            
            <!-- 预设模式 -->
            <div class="active-call-item">
              <div class="ratio-label">
                <span>预设模式</span>
              </div>
              <div class="preset-buttons">
                <button class="preset-btn" data-preset="quiet">安静模式</button>
                <button class="preset-btn" data-preset="daily">日常模式</button>
                <button class="preset-btn" data-preset="intimate">亲密模式</button>
                <button class="preset-btn active" data-preset="custom">自定义</button>
              </div>
            </div>
            
            <!-- 详细预览 -->
            <div class="active-call-preview" id="activeCallPreview">
              <p><strong>当前设置预览：</strong></p>
              <p>• 总体频率：<span id="previewFrequency">中等 (30%)</span></p>
              <p>• 呼叫类型：<span id="previewType">电话 50% / 视频 50%</span></p>
              <p>• 预计每天：<span id="previewDaily">2-4次呼叫</span></p>
              <p>• 下次呼叫：<span id="previewNext">15-30分钟内</span></p>
            </div>
          </div>
          
          <div class="communication-stats">
            <p style="margin:0 0 6px 0; font-weight:500;">通话统计</p>
            <p style="margin:4px 0;">今日通话: <span id="todayCalls">0</span> 次</p>
            <p style="margin:4px 0;">总通话时长: <span id="totalCallTime">0</span> 分钟</p>
            <p style="margin:4px 0;">今日视频: <span id="todayVideos">0</span> 次</p>
            <p style="margin:4px 0;">总视频时长: <span id="totalVideoTime">0</span> 分钟</p>
            <p style="margin:4px 0; font-size:0.75rem; color:#666;">对方今日主动呼叫: <span id="todayIncomingCalls">0</span> 次</p>
          </div>
        </div>
        
        <button class="communication-btn" id="saveCommunicationBtn">保存通话设置</button>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：通话/视频小窗口可以随意拖动位置（支持手机触摸拖动）<br>
          对方会根据您的设置主动发起通话或视频邀请
        </p>
      </div>
    </div>
    
    <!-- 音乐播放标签页 -->
    <div class="tab-content" id="musicTab">
      <div class="music-library">
        <h3>🎵 音乐播放器</h3>
        <p>上传音频文件，对方可以随机播放或主动发起听歌</p>
        
        <div class="music-controls">
          <div class="music-item">
            <label class="communication-label">上传音乐文件:</label>
            <div class="music-upload-area" id="musicUploadArea">
              <i class="material-icons" style="font-size: 2rem; color: var(--accent-gray);">music_note</i>
              <span style="color: var(--text); margin-top: 4px;">点击或拖拽上传音频</span>
              <span style="font-size: 0.7rem; color: #888; margin-top: 2px;">支持 MP3、WAV、OGG（建议大小不超过10MB）</span>
            </div>
            <input type="file" id="musicUpload" class="hidden-file-input" accept="audio/*">
          </div>
          
          <div class="music-item">
            <label class="communication-label">音乐库管理:</label>
            <div class="music-list" id="musicList">
              <!-- 音乐列表将通过JS动态生成 -->
              <div class="music-empty">
                <i class="material-icons">library_music</i>
                <span>暂无音乐，请上传音频文件</span>
              </div>
            </div>
          </div>
          
          <div class="music-item">
            <label class="communication-label">播放设置:</label>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              <label style="display: flex; align-items: center; gap: 6px; font-size: 0.8rem;">
                <input type="checkbox" id="autoPlayMusic" checked>
                <span>对方主动播放音乐</span>
              </label>
              
              <div class="active-call-item">
                <div class="ratio-label">
                  <span>音乐播放频率</span>
                  <span class="active-call-value" id="musicFrequencyValue">30%</span>
                </div>
                <input type="range" min="0" max="100" value="30" class="active-call-slider" id="musicFrequencySlider">
                <div style="display:flex; justify-content:space-between; margin-top:2px;">
                  <span style="font-size:0.7rem; color:#888;">关闭</span>
                  <span style="font-size:0.7rem; color:#888;">最高</span>
                </div>
              </div>
              
              <div class="ratio-label">
                <span>播放模式</span>
              </div>
              <div style="display: flex; gap: 8px;">
                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.75rem;">
                  <input type="radio" name="musicPlayMode" value="random" checked> 随机播放
                </label>
                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.75rem;">
                  <input type="radio" name="musicPlayMode" value="single"> 单曲循环
                </label>
                <label style="display: flex; align-items: center; gap: 4px; font-size: 0.75rem;">
                  <input type="radio" name="musicPlayMode" value="list"> 列表循环
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <button class="save-background-btn" id="saveMusicSettingsBtn" style="margin-top: 15px;">保存音乐设置</button>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          ⚡ 提示：音乐文件会保存在本地，不会上传到服务器<br>
          🎧 对方会根据设置主动播放音乐，聊天页面会出现可拖动的音乐小窗<br>
          💿 点击CD唱片可以暂停/播放，拖动进度条可以跳转
        </p>
      </div>
    </div>
    
    <!-- 云导入标签页 -->
    <div class="tab-content" id="cloudTab">
      <div class="cloud-library">
        <h3>云数据导入</h3>
        <p>导入之前导出的聊天记录数据（JSON格式）</p>
        
        <div class="cloud-controls">
          <div class="cloud-item">
            <label class="communication-label">导入JSON数据:</label>
            <textarea class="cloud-textarea" id="cloudImportTextarea" placeholder="请粘贴之前导出的JSON数据..."></textarea>
            <div style="display:flex; gap:8px;">
              <button class="cloud-btn" id="importCloudBtn">导入数据</button>
              <button class="cloud-btn" style="background:#888;" id="clearCloudBtn">清空</button>
            </div>
          </div>
          
          <div class="cloud-item">
            <div class="communication-label">从文件导入:</div>
            <input type="file" id="cloudFileUpload" class="hidden-file-input" accept=".json,.txt">
            <button class="cloud-btn" id="importFileBtn">选择文件导入</button>
          </div>
          
          <div class="cloud-info">
            <p>导入说明：</p>
            <p>1. 只能导入之前从此应用导出的JSON格式数据</p>
            <p>2. 导入会覆盖当前的所有聊天记录和设置</p>
            <p>3. 建议在导入前先导出当前数据备份</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 导出记录标签页 -->
    <div class="tab-content" id="exportTab">
      <div class="export-library">
        <h3>聊天记录导出</h3>
        <p>导出聊天记录，支持多种格式</p>
        
        <div class="export-controls">
          <div class="export-options">
            <div class="export-option">
              <input type="checkbox" id="exportMessages" checked>
              <label for="exportMessages">导出聊天消息</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportSettings" checked>
              <label for="exportSettings">导出设置信息</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportStickers" checked>
              <label for="exportStickers">导出表情包信息</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportPhrases" checked>
              <label for="exportPhrases">导出词条信息</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportTarot" checked>
              <label for="exportTarot">导出塔罗牌设置</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportBackground" checked>
              <label for="exportBackground">导出背景设置</label>
            </div>
            <div class="export-option">
              <input type="checkbox" id="exportCommunication" checked>
              <label for="exportCommunication">导出通话记录</label>
            </div>
          </div>
          
          <div class="export-formats">
            <button class="format-btn" id="exportTxtBtn">导出为TXT</button>
            <button class="format-btn" id="exportJsonBtn">导出为JSON</button>
            <button class="format-btn" id="exportHtmlBtn">导出为HTML</button>
          </div>
        </div>
        
        <button class="export-btn" id="exportAllBtn">导出全部数据</button>
        
        <p style="font-size:0.7rem; margin-top:12px; color:#888;">
          提示：导出数据包含所有聊天记录和设置<br>
          可以在其他设备或浏览器中导入使用<br>
          数据会自动保存到本地，关闭页面也不会丢失
        </p>
      </div>
    </div>
  </div>
</div>

<!-- 通话/视频小窗口会动态创建 -->

<script>
// ========================
// 第一部分：数据存储管理类
// ========================

class ChatDataManager {
    constructor() {
        this.SELF_INFO_KEY = 'seven_and_wish_self_info';
        this.OTHER_INFO_KEY = 'seven_and_wish_other_info';
        this.MESSAGES_KEY = 'seven_and_wish_messages';
        this.PHRASES_KEY = 'seven_and_wish_phrases';
        this.STICKERS_KEY = 'seven_and_wish_stickers';
        this.SEND_SETTINGS_KEY = 'seven_and_wish_send_settings';
        this.APPEARANCE_KEY = 'seven_and_wish_appearance';
        this.BACKGROUND_KEY = 'seven_and_wish_background';
        this.TAROT_KEY = 'seven_and_wish_tarot_settings';
        this.COMMUNICATION_KEY = 'seven_and_wish_communication';
        this.DRAWN_CARDS_KEY = 'seven_and_wish_drawn_cards';
        this.LOVE_DAYS_KEY = 'seven_and_wish_love_days';
        this.READ_NO_REPLY_KEY = 'seven_and_wish_read_no_reply';
        this.TODAY_DATE_KEY = 'seven_and_wish_today_date';
        this.MUSIC_SETTINGS_KEY = 'seven_and_wish_music_settings';
        
        this.DATA_VERSION_KEY = 'seven_and_wish_data_version';
        this.DATA_VERSION = '2.0';
        this.MAX_MESSAGES = 500;
        
        this.initData();
    }
    
    initData() {
        const hasAnyData = localStorage.getItem(this.SELF_INFO_KEY) !== null ||
                          localStorage.getItem(this.OTHER_INFO_KEY) !== null ||
                          localStorage.getItem(this.MESSAGES_KEY) !== null;
        
        if (!hasAnyData) {
            console.log('首次运行，创建默认数据');
            this.createDefaultData();
        }
        
        if (!localStorage.getItem(this.DATA_VERSION_KEY)) {
            localStorage.setItem(this.DATA_VERSION_KEY, this.DATA_VERSION);
        }
    }
    
    createDefaultData() {
        this.setStoredData(this.SELF_INFO_KEY, {
            nickname: '我',
            avatar: null,
            status: '在线'
        });
        
        this.setStoredData(this.OTHER_INFO_KEY, {
            nickname: '对方',
            avatar: null,
            status: '在DR',
            mood: 85
        });
        
        this.setStoredData(this.SEND_SETTINGS_KEY, {
            stickerRatio: 50,
            phraseRatio: 50,
            maxMessageCount: 3,
            autoSendFrequency: 600000
        });
        
        this.setStoredData(this.APPEARANCE_KEY, {
            appTitle: '梦角爱人',
            appSubtitle: '绝对私密的一对一聊天空间',
            loveStartDate: new Date(2024, 0, 1).toISOString(),
            moodChangeFrequency: 600000
        });
        
        this.setStoredData(this.BACKGROUND_KEY, {
            backgroundImage: null,
            opacity: 100
        });
        
        this.setStoredData(this.TAROT_KEY, {
            enabled: false,
            drawCount: 1,
            customPhrases: []
        });
        
        this.setStoredData(this.COMMUNICATION_KEY, {
            autoAcceptCalls: true,
            autoAcceptVideos: true,
            todayCalls: 0,
            todayVideos: 0,
            totalCallTime: 0,
            totalVideoTime: 0,
            todayIncomingCalls: 0,
            activeCallSettings: {
                enabled: true,
                overallFrequency: 30,
                callPreference: 50,
                presetMode: 'custom',
                minInterval: 15,
                maxInterval: 45,
                respectBusyStatus: true,
                timeSensitivity: true,
                adaptToActivity: true
            }
        });
        
        this.setStoredData(this.MUSIC_SETTINGS_KEY, {
            musicList: [],
            autoPlayMusic: true,
            musicFrequency: 30,
            playMode: 'random'
        });
        
        this.setStoredData(this.PHRASES_KEY, [
            "好的，明白了",
            "这很有趣",
            "继续聊吧",
            "让我想想",
            "很有意思的观点",
            "我不太确定",
            "可以详细说说吗",
            "我同意",
            "这是个好问题",
            "谢谢分享"
        ]);
        
        this.setStoredData(this.MESSAGES_KEY, [{
            id: Date.now(),
            text: "你好！欢迎使用私密聊天。点击右上角的齿轮图标可以管理表情包和回复词条。",
            sender: "other",
            time: this.getFormattedTime(Date.now()),
            read: true
        }]);
        
        this.setStoredData(this.STICKERS_KEY, []);
        this.setStoredData(this.DRAWN_CARDS_KEY, []);
        this.setStoredData(this.LOVE_DAYS_KEY, 1);
        this.setStoredData(this.READ_NO_REPLY_KEY, []);
        this.setStoredData(this.TODAY_DATE_KEY, new Date().toDateString());
        
        localStorage.setItem(this.DATA_VERSION_KEY, this.DATA_VERSION);
    }
    
    generateMessageId() {
        return 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    getFormattedTime(timestamp) {
        const date = new Date(timestamp);
        return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
    }
    
    getStoredData(key) {
        try {
            const data = localStorage.getItem(key);
            if (!data) return null;
            try {
                return JSON.parse(data);
            } catch (e) {
                return data;
            }
        } catch (e) {
            console.error(`读取失败 [${key}]:`, e);
            return null;
        }
    }
    
    setStoredData(key, data) {
        try {
            const dataStr = typeof data === 'object' ? JSON.stringify(data) : String(data);
            if (dataStr.length > 4.5 * 1024 * 1024) {
                console.warn(`数据过大 (${(dataStr.length/1024/1024).toFixed(2)}MB)`);
                if (key.includes('background') || key.includes('avatar') || key.includes('sticker') || key.includes('music')) {
                    console.warn('图片数据过大，跳过保存');
                    return false;
                }
            }
            if (typeof data === 'object') {
                localStorage.setItem(key, JSON.stringify(data));
            } else {
                localStorage.setItem(key, data);
            }
            return true;
        } catch (e) {
            console.error(`保存失败 [${key}]:`, e);
            if (e.name === 'QuotaExceededError') {
                this.clearOldData();
                try {
                    if (typeof data === 'object') {
                        localStorage.setItem(key, JSON.stringify(data));
                    } else {
                        localStorage.setItem(key, data);
                    }
                    return true;
                } catch (e2) {
                    console.error('重试失败:', e2);
                    return false;
                }
            }
            return false;
        }
    }
    
    clearOldData() {
        try {
            const allKeys = Object.keys(localStorage);
            const relevantKeys = allKeys.filter(key => 
                key.includes('seven_and_wish_') && 
                !key.includes(this.SELF_INFO_KEY) && 
                !key.includes(this.OTHER_INFO_KEY) &&
                !key.includes(this.MESSAGES_KEY)
            );
            
            const priorityOrder = [
                this.DRAWN_CARDS_KEY,
                this.READ_NO_REPLY_KEY,
                this.TODAY_DATE_KEY,
                this.LOVE_DAYS_KEY,
                this.STICKERS_KEY,
                this.MUSIC_SETTINGS_KEY,
            ];
            
            for (const key of priorityOrder) {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    console.log(`已清理: ${key}`);
                    break;
                }
            }
        } catch (e) {
            console.error('清理失败:', e);
        }
    }
    
    getSelfInfo() {
        return this.getStoredData(this.SELF_INFO_KEY) || { nickname: '我', avatar: null, status: '在线' };
    }
    saveSelfInfo(data) { return this.setStoredData(this.SELF_INFO_KEY, data); }
    
    getOtherInfo() {
        return this.getStoredData(this.OTHER_INFO_KEY) || { nickname: '对方', avatar: null, status: '在DR', mood: 85 };
    }
    saveOtherInfo(data) { return this.setStoredData(this.OTHER_INFO_KEY, data); }
    
    getMessages() { return this.getStoredData(this.MESSAGES_KEY) || []; }
    saveMessage(message) {
        const messages = this.getMessages();
        messages.push(message);
        if (messages.length > this.MAX_MESSAGES) messages.splice(0, messages.length - this.MAX_MESSAGES);
        return this.setStoredData(this.MESSAGES_KEY, messages);
    }
    saveAllMessages(messages) {
        if (messages.length > this.MAX_MESSAGES) messages = messages.slice(-this.MAX_MESSAGES);
        return this.setStoredData(this.MESSAGES_KEY, messages);
    }
    deleteMessage(messageId) {
        const messages = this.getMessages();
        const filtered = messages.filter(msg => msg.id !== messageId);
        return filtered.length < messages.length ? this.setStoredData(this.MESSAGES_KEY, filtered) : false;
    }
    
    getPhrases() { return this.getStoredData(this.PHRASES_KEY) || []; }
    savePhrases(phrases) { return this.setStoredData(this.PHRASES_KEY, phrases); }
    
    getStickers() { return this.getStoredData(this.STICKERS_KEY) || []; }
    saveStickers(stickers) { return this.setStoredData(this.STICKERS_KEY, stickers); }
    
    getSendSettings() {
        return this.getStoredData(this.SEND_SETTINGS_KEY) || { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
    }
    saveSendSettings(settings) { return this.setStoredData(this.SEND_SETTINGS_KEY, settings); }
    
    getAppearanceSettings() {
        const data = this.getStoredData(this.APPEARANCE_KEY);
        if (data && data.loveStartDate) data.loveStartDate = new Date(data.loveStartDate);
        return data || { appTitle: '梦角爱人', appSubtitle: '绝对私密的一对一聊天空间', loveStartDate: new Date(2024, 0, 1), moodChangeFrequency: 600000 };
    }
    saveAppearanceSettings(settings) {
        const dataToSave = { ...settings, loveStartDate: settings.loveStartDate instanceof Date ? settings.loveStartDate.toISOString() : settings.loveStartDate };
        return this.setStoredData(this.APPEARANCE_KEY, dataToSave);
    }
    
    getBackgroundSettings() { return this.getStoredData(this.BACKGROUND_KEY) || { backgroundImage: null, opacity: 100 }; }
    saveBackgroundSettings(settings) { return this.setStoredData(this.BACKGROUND_KEY, settings); }
    
    getTarotSettings() { return this.getStoredData(this.TAROT_KEY) || { enabled: false, drawCount: 1, customPhrases: [] }; }
    saveTarotSettings(settings) { return this.setStoredData(this.TAROT_KEY, settings); }
    
    getDrawnCards() { return new Set(this.getStoredData(this.DRAWN_CARDS_KEY) || []); }
    saveDrawnCards(cardSet) { return this.setStoredData(this.DRAWN_CARDS_KEY, Array.from(cardSet)); }
    
    getCommunicationSettings() {
        return this.getStoredData(this.COMMUNICATION_KEY) || {
            autoAcceptCalls: true, autoAcceptVideos: true, todayCalls: 0, todayVideos: 0, totalCallTime: 0, totalVideoTime: 0, todayIncomingCalls: 0,
            activeCallSettings: { enabled: true, overallFrequency: 30, callPreference: 50, presetMode: 'custom', minInterval: 15, maxInterval: 45, respectBusyStatus: true, timeSensitivity: true, adaptToActivity: true }
        };
    }
    saveCommunicationSettings(settings) { return this.setStoredData(this.COMMUNICATION_KEY, settings); }
    
    getMusicSettings() { return this.getStoredData(this.MUSIC_SETTINGS_KEY) || { musicList: [], autoPlayMusic: true, musicFrequency: 30, playMode: 'random' }; }
    saveMusicSettings(settings) { return this.setStoredData(this.MUSIC_SETTINGS_KEY, settings); }
    
    getLoveDays() { return this.getStoredData(this.LOVE_DAYS_KEY) || 1; }
    saveLoveDays(days) { return this.setStoredData(this.LOVE_DAYS_KEY, days); }
    
    getReadNoReplyIds() { return this.getStoredData(this.READ_NO_REPLY_KEY) || []; }
    saveReadNoReplyIds(ids) { return this.setStoredData(this.READ_NO_REPLY_KEY, ids); }
    
    getTodayDate() { return this.getStoredData(this.TODAY_DATE_KEY) || new Date().toDateString(); }
    saveTodayDate(dateStr) { return this.setStoredData(this.TODAY_DATE_KEY, dateStr); }
    
    clearAllData() {
        try {
            Object.keys(localStorage).filter(key => key.includes('seven_and_wish_')).forEach(key => localStorage.removeItem(key));
            this.createDefaultData();
            return true;
        } catch (e) {
            console.error('清除失败:', e);
            return false;
        }
    }
}

// ========================
// 第二部分：应用主类
// ========================

class ChatApp {
    constructor() {
        this.dataManager = new ChatDataManager();
        this.appData = {
            selfInfo: null, otherInfo: null, messages: null, responsePhrases: null, stickers: null,
            sendSettings: null, appearanceSettings: null, backgroundSettings: null, tarotSettings: null,
            communicationSettings: null, musicSettings: null, drawnCards: null, loveDays: null,
            readNoReplyMessageIds: null, todayDate: null,
            isTyping: false, waitingForReply: false, quotedMessage: null, activeCall: null, activeVideo: null,
            callTimer: null, callStartTime: null, activeMessageActions: null, moodTimer: null,
            autoSendTimer: null, activeCallTimer: null, musicTimer: null, activeMusicPlayer: null,
            musicAudio: null, isMusicPlaying: false, currentPlayingMusic: null, editingUserType: null
        };
        
        this.DEFAULT_TAROT_CARDS = [
            "愚人 正位", "愚人 逆位", "魔术师 正位", "魔术师 逆位",
            "女祭司 正位", "女祭司 逆位", "女皇 正位", "女皇 逆位",
            "皇帝 正位", "皇帝 逆位", "教皇 正位", "教皇 逆位",
            "恋人 正位", "恋人 逆位", "战车 正位", "战车 逆位",
            "力量 正位", "力量 逆位", "隐士 正位", "隐士 逆位",
            "命运之轮 正位", "命运之轮 逆位", "正义 正位", "正义 逆位",
            "倒吊人 正位", "倒吊人 逆位", "死神 正位", "死神 逆位",
            "节制 正位", "节制 逆位", "恶魔 正位", "恶魔 逆位",
            "高塔 正位", "高塔 逆位", "星星 正位", "星星 逆位",
            "月亮 正位", "月亮 逆位", "太阳 正位", "太阳 逆位",
            "审判 正位", "审判 逆位", "世界 正位", "世界 逆位",
            "权杖一 正位", "权杖一 逆位", "权杖二 正位", "权杖二 逆位",
            "权杖三 正位", "权杖三 逆位", "权杖四 正位", "权杖四 逆位",
            "权杖五 正位", "权杖五 逆位", "权杖六 正位", "权杖六 逆位",
            "权杖七 正位", "权杖七 逆位", "权杖八 正位", "权杖八 逆位",
            "权杖九 正位", "权杖九 逆位", "权杖十 正位", "权杖十 逆位",
            "权杖侍从 正位", "权杖侍从 逆位", "权杖骑士 正位", "权杖骑士 逆位",
            "权杖皇后 正位", "权杖皇后 逆位", "权杖国王 正位", "权杖国王 逆位"
        ];
        
        this.PRESET_MODES = {
            quiet: { name: '安静模式', overallFrequency: 10, callPreference: 30 },
            daily: { name: '日常模式', overallFrequency: 30, callPreference: 50 },
            intimate: { name: '亲密模式', overallFrequency: 50, callPreference: 70 },
            custom: { name: '自定义' }
        };
        
        this.init();
    }
    
    loadAllData() {
        this.appData.selfInfo = this.dataManager.getSelfInfo();
        this.appData.otherInfo = this.dataManager.getOtherInfo();
        this.appData.messages = this.dataManager.getMessages();
        this.appData.responsePhrases = this.dataManager.getPhrases();
        this.appData.stickers = this.dataManager.getStickers();
        this.appData.sendSettings = this.dataManager.getSendSettings();
        this.appData.appearanceSettings = this.dataManager.getAppearanceSettings();
        this.appData.backgroundSettings = this.dataManager.getBackgroundSettings();
        this.appData.tarotSettings = this.dataManager.getTarotSettings();
        this.appData.communicationSettings = this.dataManager.getCommunicationSettings();
        this.appData.musicSettings = this.dataManager.getMusicSettings();
        this.appData.drawnCards = this.dataManager.getDrawnCards();
        this.appData.loveDays = this.dataManager.getLoveDays();
        this.appData.readNoReplyMessageIds = this.dataManager.getReadNoReplyIds();
        this.appData.todayDate = this.dataManager.getTodayDate();
        
        this.checkResetDailyStats();
        this.calculateLoveDays();
    }
    
    saveAllData() {
        this.dataManager.saveSelfInfo(this.appData.selfInfo);
        this.dataManager.saveOtherInfo(this.appData.otherInfo);
        this.dataManager.saveAllMessages(this.appData.messages);
        this.dataManager.savePhrases(this.appData.responsePhrases);
        this.dataManager.saveStickers(this.appData.stickers);
        this.dataManager.saveSendSettings(this.appData.sendSettings);
        this.dataManager.saveAppearanceSettings(this.appData.appearanceSettings);
        this.dataManager.saveBackgroundSettings(this.appData.backgroundSettings);
        this.dataManager.saveTarotSettings(this.appData.tarotSettings);
        this.dataManager.saveCommunicationSettings(this.appData.communicationSettings);
        this.dataManager.saveMusicSettings(this.appData.musicSettings);
        this.dataManager.saveDrawnCards(this.appData.drawnCards);
        this.dataManager.saveLoveDays(this.appData.loveDays);
        this.dataManager.saveReadNoReplyIds(this.appData.readNoReplyMessageIds);
        this.dataManager.saveTodayDate(this.appData.todayDate);
    }
    
    checkResetDailyStats() {
        const currentDate = new Date().toDateString();
        if (this.appData.todayDate !== currentDate) {
            this.appData.communicationSettings.todayCalls = 0;
            this.appData.communicationSettings.todayVideos = 0;
            this.appData.communicationSettings.todayIncomingCalls = 0;
            this.appData.todayDate = currentDate;
        }
    }
    
    calculateLoveDays() {
        const today = new Date();
        const startDate = this.appData.appearanceSettings.loveStartDate;
        if (startDate && startDate instanceof Date) {
            const timeDiff = today.getTime() - startDate.getTime();
            this.appData.loveDays = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
            if (this.appData.loveDays < 1) this.appData.loveDays = 1;
            const loveDaysSpan = document.getElementById('loveDaysCount');
            if (loveDaysSpan) loveDaysSpan.textContent = this.appData.loveDays;
        }
    }
    
    init() {
        this.loadAllData();
        this.markOtherMessagesAsRead();
        this.renderAllUI();
        this.startAllTimers();
        this.setupEventListeners();
        
        this.showNotification('聊天记录已加载');
        
        setInterval(() => this.saveAllData(), 30000);
        window.addEventListener('beforeunload', () => this.saveAllData());
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') this.saveAllData(); });
    }
    
    startAllTimers() {
        this.startMoodChanging();
        this.startAutoSending();
        this.startActiveCallScheduler();
        this.startMusicScheduler();
    }
    
    markOtherMessagesAsRead() {
        if (this.appData.messages) this.appData.messages.forEach(msg => { if (msg.sender === 'other') msg.read = true; });
    }
    
    renderAllUI() {
        this.renderMessages();
        this.renderStickerPreview();
        this.renderPhrasesTextarea();
        this.renderTarotUI();
        this.renderBackgroundUI();
        this.renderUserInfo();
        this.renderAppearance();
        this.renderCommunicationStats();
        this.initSendSettingsUI();
        this.initAppearanceSettingsUI();
        this.initCommunicationSettingsUI();
        this.initActiveCallSettingsUI();
        this.initMusicSettingsUI();
        
        this.updateStickerCount();
        this.updatePhraseCount();
        this.updateTarotPhraseCount();
    }
    
    renderMessages() {
        const messagesArea = document.getElementById('messagesArea');
        if (!messagesArea) return;
        
        messagesArea.innerHTML = '';
        
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            messagesArea.appendChild(typingIndicator);
            typingIndicator.classList.toggle('active', this.appData.isTyping);
        }
        
        if (!this.appData.messages || this.appData.messages.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'message other';
            emptyMessage.innerHTML = `还没有聊天记录，开始聊天吧！<div class="message-time"><span>${this.getCurrentTime()}</span></div>`;
            messagesArea.appendChild(emptyMessage);
        } else {
            this.appData.messages.forEach(msg => {
                const messageContainer = document.createElement('div');
                messageContainer.className = `message-container ${msg.sender}`;
                
                const messageAvatar = document.createElement('div');
                messageAvatar.className = 'message-avatar';
                const avatarInfo = msg.sender === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
                messageAvatar.innerHTML = avatarInfo && avatarInfo.avatar ? `<img src="${avatarInfo.avatar}" alt="${avatarInfo.nickname}">` : '<span></span>';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}`;
                
                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions';
                messageActions.innerHTML = `
                    <button class="message-action-btn quote" data-id="${msg.id}">引用</button>
                    <button class="message-action-btn delete" data-id="${msg.id}">删除</button>
                    ${msg.sender === 'self' ? '<button class="message-action-btn recall" data-id="' + msg.id + '">撤回</button>' : ''}
                `;
                
                messageDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (this.appData.activeMessageActions && this.appData.activeMessageActions !== messageActions) {
                        this.appData.activeMessageActions.style.display = 'none';
                    }
                    if (messageActions.style.display === 'flex') {
                        messageActions.style.display = 'none';
                        this.appData.activeMessageActions = null;
                    } else {
                        messageActions.style.display = 'flex';
                        this.appData.activeMessageActions = messageActions;
                    }
                });
                
                const isCallMessage = msg.type === 'call' || msg.type === 'video';
                const isTarotMessage = msg.isTarot;
                const isReadNoReply = msg.id && this.appData.readNoReplyMessageIds && this.appData.readNoReplyMessageIds.includes(msg.id);
                
                let quotedContent = '';
                if (msg.quotedMessage) {
                    const quoted = msg.quotedMessage;
                    quotedContent = `<div class="quoted-message" data-id="${quoted.id}">${quoted.isSticker ? '<img src="' + quoted.stickerData + '" alt="表情包" style="max-height:20px;">' : (quoted.text || '')}</div>`;
                }
                
                if (msg.isSticker && msg.stickerData) {
                    messageDiv.innerHTML = `${quotedContent}<img src="${msg.stickerData}" alt="表情包" style="max-width: 100px; border-radius: 6px;"><div class="message-time"><span>${msg.time || ''}</span><span class="message-status"><span class="status-check ${msg.read ? 'double' : 'single'}">${msg.read ? '✓✓' : '✓'}</span>${isReadNoReply ? '<span class="read-no-reply">👀 已读不回</span>' : ''}</span></div>`;
                } else {
                    messageDiv.innerHTML = `${quotedContent}${isTarotMessage ? '🔮 ' : ''}${msg.text || ''}<div class="message-time"><span>${msg.time || ''}</span><span class="message-status"><span class="status-check ${msg.read ? 'double' : 'single'}">${msg.read ? '✓✓' : '✓'}</span>${isReadNoReply ? '<span class="read-no-reply">👀 已读不回</span>' : ''}</span></div>`;
                }
                
                if (isCallMessage) messageDiv.classList.add(`${msg.type}-message`);
                if (isTarotMessage) messageDiv.classList.add('tarot-message');
                
                messageContent.appendChild(messageDiv);
                messageContent.appendChild(messageActions);
                messageContainer.appendChild(messageAvatar);
                messageContainer.appendChild(messageContent);
                messagesArea.appendChild(messageContainer);
                
                messageActions.querySelector('.quote')?.addEventListener('click', (e) => { e.stopPropagation(); this.quoteMessage(msg); messageActions.style.display = 'none'; this.appData.activeMessageActions = null; });
                messageActions.querySelector('.delete')?.addEventListener('click', (e) => { e.stopPropagation(); this.deleteMessage(msg.id); messageActions.style.display = 'none'; this.appData.activeMessageActions = null; });
                messageActions.querySelector('.recall')?.addEventListener('click', (e) => { e.stopPropagation(); this.recallMessage(msg.id); messageActions.style.display = 'none'; this.appData.activeMessageActions = null; });
            });
        }
        
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
    
    renderStickerPreview() {
        const stickerPreview = document.getElementById('stickerPreview');
        if (!stickerPreview) return;
        stickerPreview.innerHTML = '';
        
        if (this.appData.stickers) {
            this.appData.stickers.forEach(sticker => {
                const stickerItem = document.createElement('div');
                stickerItem.className = 'sticker-item';
                stickerItem.innerHTML = `<img src="${sticker.data}" alt="表情包"><button class="delete-sticker" data-id="${sticker.id}">×</button>`;
                stickerItem.querySelector('.delete-sticker').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.appData.stickers = this.appData.stickers.filter(s => s.id !== sticker.id);
                    this.renderStickerPreview();
                    this.saveAllData();
                    this.showNotification('表情包已删除');
                });
                stickerPreview.appendChild(stickerItem);
            });
        }
        
        const addButton = document.createElement('div');
        addButton.className = 'sticker-item';
        addButton.id = 'addStickerPlaceholder';
        addButton.innerHTML = '<div class="sticker-placeholder">+</div>';
        addButton.addEventListener('click', () => document.getElementById('stickerUpload')?.click());
        stickerPreview.appendChild(addButton);
        
        this.updateStickerCount();
    }
    
    renderPhrasesTextarea() {
        const textarea = document.getElementById('phrasesTextarea');
        if (textarea && this.appData.responsePhrases) {
            textarea.value = this.appData.responsePhrases.join('\n');
            this.updatePhraseCount();
        }
    }
    
    renderTarotUI() {
        const tarotModeToggle = document.getElementById('tarotModeToggle');
        if (tarotModeToggle) tarotModeToggle.checked = this.appData.tarotSettings?.enabled || false;
        
        const tarotCountValue = document.getElementById('tarotCountValue');
        if (tarotCountValue) tarotCountValue.textContent = this.appData.tarotSettings?.drawCount || 1;
        
        const tarotNumberSelector = document.getElementById('tarotNumberSelector');
        if (tarotNumberSelector) {
            tarotNumberSelector.innerHTML = '';
            for (let i = 1; i <= 15; i++) {
                const numberDiv = document.createElement('div');
                numberDiv.className = `tarot-number ${i === (this.appData.tarotSettings?.drawCount || 1) ? 'active' : ''}`;
                numberDiv.textContent = i;
                numberDiv.dataset.number = i;
                numberDiv.addEventListener('click', () => this.selectTarotNumber(i));
                tarotNumberSelector.appendChild(numberDiv);
            }
        }
        
        const tarotTextarea = document.getElementById('tarotTextarea');
        if (tarotTextarea && this.appData.tarotSettings?.customPhrases) {
            tarotTextarea.value = this.appData.tarotSettings.customPhrases.join('\n');
        }
        
        this.updateTarotPhraseCount();
        this.updateTarotStatus();
    }
    
    renderBackgroundUI() {
        this.updateBackgroundPreview();
        const slider = document.getElementById('backgroundOpacitySlider');
        const value = document.getElementById('backgroundOpacityValue');
        if (slider && value && this.appData.backgroundSettings) {
            slider.value = this.appData.backgroundSettings.opacity || 100;
            value.textContent = `${this.appData.backgroundSettings.opacity || 100}%`;
        }
        this.applyBackgroundSettings();
    }
    
    renderUserInfo() {
        const selfAvatar = document.getElementById('selfAvatar');
        if (selfAvatar) {
            selfAvatar.innerHTML = this.appData.selfInfo?.avatar ? `<img src="${this.appData.selfInfo.avatar}" alt="${this.appData.selfInfo.nickname}">` : '<span></span>';
        }
        const selfNickname = document.getElementById('selfNickname');
        if (selfNickname) selfNickname.textContent = this.appData.selfInfo?.nickname || '我';
        
        const otherAvatar = document.getElementById('otherAvatar');
        if (otherAvatar) {
            otherAvatar.innerHTML = this.appData.otherInfo?.avatar ? `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : '<span></span>';
        }
        const otherNickname = document.getElementById('otherNickname');
        if (otherNickname) otherNickname.textContent = this.appData.otherInfo?.nickname || '对方';
    }
    
    renderAppearance() {
        const appTitle = document.getElementById('appTitle');
        if (appTitle) appTitle.textContent = this.appData.appearanceSettings?.appTitle || '梦角爱人';
        const appSubtitle = document.getElementById('appSubtitle');
        if (appSubtitle) appSubtitle.textContent = this.appData.appearanceSettings?.appSubtitle || '绝对私密的一对一聊天空间';
        const loveDaysCount = document.getElementById('loveDaysCount');
        if (loveDaysCount) loveDaysCount.textContent = this.appData.loveDays || 1;
    }
    
    renderCommunicationStats() {
        const todayCalls = document.getElementById('todayCalls');
        if (todayCalls) todayCalls.textContent = this.appData.communicationSettings?.todayCalls || 0;
        const todayVideos = document.getElementById('todayVideos');
        if (todayVideos) todayVideos.textContent = this.appData.communicationSettings?.todayVideos || 0;
    }
    
    initSendSettingsUI() {
        const stickerRatioSlider = document.getElementById('stickerRatioSlider');
        const phraseRatioSlider = document.getElementById('phraseRatioSlider');
        const stickerRatioValue = document.getElementById('stickerRatioValue');
        const phraseRatioValue = document.getElementById('phraseRatioValue');
        const maxMessageCount = document.getElementById('maxMessageCount');
        const autoSendFrequency = document.getElementById('autoSendFrequency');
        
        if (stickerRatioSlider && this.appData.sendSettings) stickerRatioSlider.value = this.appData.sendSettings.stickerRatio || 50;
        if (phraseRatioSlider && this.appData.sendSettings) phraseRatioSlider.value = this.appData.sendSettings.phraseRatio || 50;
        if (stickerRatioValue && this.appData.sendSettings) stickerRatioValue.textContent = `${this.appData.sendSettings.stickerRatio || 50}%`;
        if (phraseRatioValue && this.appData.sendSettings) phraseRatioValue.textContent = `${this.appData.sendSettings.phraseRatio || 50}%`;
        if (maxMessageCount && this.appData.sendSettings) maxMessageCount.value = this.appData.sendSettings.maxMessageCount || 3;
        if (autoSendFrequency && this.appData.sendSettings) autoSendFrequency.value = this.appData.sendSettings.autoSendFrequency || 600000;
    }
    
    initAppearanceSettingsUI() {
        const appTitleInput = document.getElementById('appTitleInput');
        const appSubtitleInput = document.getElementById('appSubtitleInput');
        const loveYear = document.getElementById('loveYear');
        const loveMonth = document.getElementById('loveMonth');
        const loveDay = document.getElementById('loveDay');
        const moodChangeFrequency = document.getElementById('moodChangeFrequency');
        
        if (appTitleInput && this.appData.appearanceSettings) appTitleInput.value = this.appData.appearanceSettings.appTitle || '梦角爱人';
        if (appSubtitleInput && this.appData.appearanceSettings) appSubtitleInput.value = this.appData.appearanceSettings.appSubtitle || '绝对私密的一对一聊天空间';
        
        if (this.appData.appearanceSettings?.loveStartDate) {
            const date = new Date(this.appData.appearanceSettings.loveStartDate);
            if (loveYear) loveYear.value = date.getFullYear();
            if (loveMonth) loveMonth.value = date.getMonth() + 1;
            if (loveDay) loveDay.value = date.getDate();
        }
        
        if (moodChangeFrequency && this.appData.appearanceSettings) moodChangeFrequency.value = this.appData.appearanceSettings.moodChangeFrequency || 600000;
    }
    
    initCommunicationSettingsUI() {
        const autoAcceptCalls = document.getElementById('autoAcceptCalls');
        const autoAcceptVideos = document.getElementById('autoAcceptVideos');
        if (autoAcceptCalls && this.appData.communicationSettings) autoAcceptCalls.checked = this.appData.communicationSettings.autoAcceptCalls !== false;
        if (autoAcceptVideos && this.appData.communicationSettings) autoAcceptVideos.checked = this.appData.communicationSettings.autoAcceptVideos !== false;
    }
    
    initActiveCallSettingsUI() {
        const overallFrequencySlider = document.getElementById('overallFrequencySlider');
        const callPreferenceSlider = document.getElementById('callPreferenceSlider');
        if (overallFrequencySlider && this.appData.communicationSettings?.activeCallSettings) {
            overallFrequencySlider.value = this.appData.communicationSettings.activeCallSettings.overallFrequency || 30;
            this.updateOverallFrequencyDisplay();
        }
        if (callPreferenceSlider && this.appData.communicationSettings?.activeCallSettings) {
            callPreferenceSlider.value = this.appData.communicationSettings.activeCallSettings.callPreference || 50;
            this.updateCallPreferenceDisplay();
        }
        this.updateActiveCallPreview();
        this.updatePresetButtons();
    }
    
    updateStickerCount() {
        const countEl = document.getElementById('stickerCount');
        if (countEl) countEl.textContent = this.appData.stickers?.length || 0;
    }
    
    updatePhraseCount() {
        const textarea = document.getElementById('phrasesTextarea');
        const countEl = document.getElementById('phraseCount');
        if (textarea && countEl) {
            const text = textarea.value.trim();
            if (!text) countEl.textContent = '0';
            else countEl.textContent = text.split('\n').map(p => p.trim()).filter(p => p.length > 0).length;
        }
    }
    
    updateTarotPhraseCount() {
        const countEl = document.getElementById('tarotPhraseCount');
        if (countEl && this.appData.tarotSettings) countEl.textContent = this.appData.tarotSettings.customPhrases?.length || 0;
    }
    
    updateTarotStatus() {
        const statusEl = document.getElementById('tarotStatus');
        if (!statusEl) return;
        const enabled = this.appData.tarotSettings?.enabled || false;
        const drawCount = this.appData.tarotSettings?.drawCount || 1;
        const count = this.appData.tarotSettings?.customPhrases?.length || 0;
        if (enabled) {
            statusEl.innerHTML = `<strong>塔罗牌模式已开启 🔮</strong><br>对方抽取 <strong>${drawCount}</strong> 张<br>字卡库: ${count} 张`;
            statusEl.style.background = 'var(--tarot-bg)';
            statusEl.style.color = 'var(--tarot-text)';
        } else {
            statusEl.innerHTML = `<strong>塔罗牌模式已关闭</strong><br>对方使用普通词条和表情包回复`;
            statusEl.style.background = 'rgba(255, 255, 255, 0.7)';
            statusEl.style.color = 'var(--text)';
        }
    }
    
    updateBackgroundPreview() {
        const preview = document.getElementById('backgroundPreview');
        if (!preview) return;
        if (this.appData.backgroundSettings?.backgroundImage) {
            preview.innerHTML = `<img src="${this.appData.backgroundSettings.backgroundImage}" alt="背景预览">`;
            preview.style.backgroundImage = `url(${this.appData.backgroundSettings.backgroundImage})`;
        } else {
            preview.innerHTML = `<div class="empty"><i class="material-icons">wallpaper</i><span>默认背景</span></div>`;
        }
    }
    
    applyBackgroundSettings() {
        const container = document.getElementById('backgroundContainer');
        if (!container) return;
        if (this.appData.backgroundSettings?.backgroundImage) {
            container.style.backgroundImage = `url(${this.appData.backgroundSettings.backgroundImage})`;
            container.style.opacity = (this.appData.backgroundSettings.opacity / 100).toString();
        } else {
            container.style.backgroundImage = 'none';
            container.style.opacity = '1';
        }
    }
    
    updateOverallFrequencyDisplay() {
        const value = this.appData.communicationSettings?.activeCallSettings?.overallFrequency || 30;
        const el = document.getElementById('overallFrequencyValue');
        if (el) el.textContent = `${value}%`;
    }
    
    updateCallPreferenceDisplay() {
        const value = this.appData.communicationSettings?.activeCallSettings?.callPreference || 50;
        const el = document.getElementById('callPreferenceValue');
        if (el) el.textContent = `电话 ${value}% / 视频 ${100-value}%`;
    }
    
    updateActiveCallPreview() {
        const settings = this.appData.communicationSettings?.activeCallSettings;
        if (!settings) return;
        const frequency = settings.overallFrequency || 30;
        const previewFrequency = document.getElementById('previewFrequency');
        if (previewFrequency) previewFrequency.textContent = `${frequency}%`;
    }
    
    updatePresetButtons() {
        const preset = this.appData.communicationSettings?.activeCallSettings?.presetMode || 'custom';
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-preset') === preset);
        });
    }
    
    startMoodChanging() {
        if (this.appData.moodTimer) clearInterval(this.appData.moodTimer);
        const frequency = this.appData.appearanceSettings?.moodChangeFrequency || 600000;
        this.appData.moodTimer = setInterval(() => {
            if (this.appData.otherInfo) {
                const change = Math.floor(Math.random() * 21) - 10;
                this.appData.otherInfo.mood = Math.max(0, Math.min(100, (this.appData.otherInfo.mood || 85) + change));
                this.saveAllData();
            }
        }, frequency);
    }
    
    startAutoSending() {
        if (this.appData.autoSendTimer) clearInterval(this.appData.autoSendTimer);
        const frequency = this.appData.sendSettings?.autoSendFrequency || 600000;
        if (frequency > 0) {
            this.appData.autoSendTimer = setInterval(() => { if (Math.random() > 0.5) this.autoSendMessage(); }, frequency);
        }
    }
    
    startActiveCallScheduler() {
        if (this.appData.activeCallTimer) clearInterval(this.appData.activeCallTimer);
        const settings = this.appData.communicationSettings?.activeCallSettings;
        if (!settings || !settings.enabled || settings.overallFrequency <= 0) return;
        const baseInterval = 60000;
        const checkInterval = baseInterval * (100 / Math.max(settings.overallFrequency, 10));
        this.appData.activeCallTimer = setInterval(() => {
            if (Math.random() * 100 < (settings.overallFrequency || 30)) {
                this.simulateIncomingCall(Math.random() * 100 < (settings.callPreference || 50) ? 'call' : 'video');
            }
        }, checkInterval);
    }
    
    simulateIncomingCall(type) {
        if (this.appData.activeCall || this.appData.activeVideo) return;
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.todayIncomingCalls = (this.appData.communicationSettings.todayIncomingCalls || 0) + 1;
            this.saveAllData();
        }
        if (type === 'call') {
            this.createCallWindow('incoming');
            this.showNotification('对方来电');
        } else {
            this.createVideoWindow('incoming');
            this.showNotification('对方发起视频通话');
        }
    }
    
    sendMessage() {
        const input = document.getElementById('messageInput');
        if (!input) return;
        const text = input.value.trim();
        if (!text && !this.appData.quotedMessage) return;
        
        const userMessage = {
            id: this.dataManager.generateMessageId(),
            text: text,
            sender: 'self',
            time: this.getCurrentTime(),
            read: false,
            quotedMessage: this.appData.quotedMessage ? {...this.appData.quotedMessage} : null
        };
        
        this.appData.messages.push(userMessage);
        this.renderMessages();
        
        input.value = '';
        this.appData.quotedMessage = null;
        input.placeholder = '输入消息...';
        
        this.saveAllData();
        
        const willReply = Math.random() > 0.2;
        if (willReply) {
            this.appData.waitingForReply = true;
            this.startTypingIndicator();
            setTimeout(() => {
                if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                    this.generateTarotReply('reply');
                } else {
                    this.generateReply(userMessage.id);
                }
            }, 1500 + Math.random() * 2000);
        } else {
            this.appData.waitingForReply = false;
            setTimeout(() => {
                this.markSelfMessagesAsRead();
                if (userMessage.id) {
                    if (!this.appData.readNoReplyMessageIds) this.appData.readNoReplyMessageIds = [];
                    this.appData.readNoReplyMessageIds.push(userMessage.id);
                }
                this.renderMessages();
                this.showNotification('对方已读不回');
                this.saveAllData();
            }, 1000 + Math.random() * 3000);
        }
    }
    
    getCurrentTime() {
        const now = new Date();
        return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
    }
    
    startTypingIndicator() { this.appData.isTyping = true; this.renderMessages(); }
    stopTypingIndicator() { this.appData.isTyping = false; this.renderMessages(); }
    
    markSelfMessagesAsRead() {
        if (this.appData.messages) this.appData.messages.forEach(msg => { if (msg.sender === 'self') msg.read = true; });
    }
    
    generateReply(messageId) {
        this.stopTypingIndicator();
        this.markSelfMessagesAsRead();
        
        if (messageId && this.appData.readNoReplyMessageIds) {
            const index = this.appData.readNoReplyMessageIds.indexOf(messageId);
            if (index > -1) this.appData.readNoReplyMessageIds.splice(index, 1);
        }
        
        const messageCount = Math.floor(Math.random() * (this.appData.sendSettings?.maxMessageCount || 3)) + 1;
        const totalRatio = (this.appData.sendSettings?.stickerRatio || 50) + (this.appData.sendSettings?.phraseRatio || 50);
        const stickerProbability = (this.appData.sendSettings?.stickerRatio || 50) / totalRatio;
        
        const messagesToSend = [];
        for (let i = 0; i < messageCount; i++) {
            const isSticker = Math.random() < stickerProbability && this.appData.stickers?.length > 0;
            if (isSticker) {
                const randomSticker = this.appData.stickers[Math.floor(Math.random() * this.appData.stickers.length)];
                messagesToSend.push({ type: 'sticker', data: randomSticker.data });
            } else {
                const randomPhrase = this.appData.responsePhrases[Math.floor(Math.random() * this.appData.responsePhrases.length)];
                messagesToSend.push({ type: 'text', data: randomPhrase });
            }
        }
        
        const firstMsg = messagesToSend[0];
        const firstMessage = {
            id: this.dataManager.generateMessageId(),
            isSticker: firstMsg.type === 'sticker',
            [firstMsg.type === 'sticker' ? 'stickerData' : 'text']: firstMsg.data,
            sender: 'other',
            time: this.getCurrentTime(),
            read: true
        };
        
        this.appData.messages.push(firstMessage);
        this.renderMessages();
        
        if (messagesToSend.length > 1) {
            for (let i = 1; i < messagesToSend.length; i++) {
                setTimeout(() => {
                    const msg = messagesToSend[i];
                    const additionalMessage = {
                        id: this.dataManager.generateMessageId(),
                        isSticker: msg.type === 'sticker',
                        [msg.type === 'sticker' ? 'stickerData' : 'text']: msg.data,
                        sender: 'other',
                        time: this.getCurrentTime(),
                        read: true
                    };
                    this.appData.messages.push(additionalMessage);
                    this.renderMessages();
                }, i * 800 + Math.random() * 500);
            }
        }
        
        this.appData.waitingForReply = false;
        this.saveAllData();
    }
    
    generateTarotReply(source) {
        if (!this.appData.tarotSettings?.enabled || !this.appData.tarotSettings.customPhrases?.length) {
            if (source === 'reply') this.generateReply();
            else this.autoSendMessage();
            return;
        }
        
        const drawCount = Math.min(this.appData.tarotSettings.drawCount || 1, this.appData.tarotSettings.customPhrases.length);
        let availablePhrases = [...this.appData.tarotSettings.customPhrases];
        
        const selectedPhrases = [];
        for (let i = 0; i < drawCount && availablePhrases.length > 0; i++) {
            const randomIndex = Math.floor(Math.random() * availablePhrases.length);
            selectedPhrases.push(availablePhrases[randomIndex]);
            availablePhrases.splice(randomIndex, 1);
        }
        
        this.sendTarotMessages(selectedPhrases, source);
    }
    
    sendTarotMessages(selectedPhrases, source) {
        const firstMessage = {
            id: this.dataManager.generateMessageId(),
            text: selectedPhrases[0],
            sender: 'other',
            time: this.getCurrentTime(),
            read: true,
            isTarot: true
        };
        
        this.appData.messages.push(firstMessage);
        this.renderMessages();
        
        if (selectedPhrases.length > 1) {
            for (let i = 1; i < selectedPhrases.length; i++) {
                setTimeout(() => {
                    const additionalMessage = {
                        id: this.dataManager.generateMessageId(),
                        text: selectedPhrases[i],
                        sender: 'other',
                        time: this.getCurrentTime(),
                        read: true,
                        isTarot: true
                    };
                    this.appData.messages.push(additionalMessage);
                    this.renderMessages();
                }, i * 1000 + Math.random() * 500);
            }
        }
        
        this.showNotification(`对方回复了${selectedPhrases.length}张塔罗牌 🔮`);
        this.saveAllData();
    }
    
    autoSendMessage() {
        this.appData.isTyping = true;
        this.renderMessages();
        
        setTimeout(() => {
            this.appData.isTyping = false;
            
            if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                this.generateTarotReply('auto');
            } else {
                const messageCount = Math.floor(Math.random() * 3) + 1;
                const totalRatio = (this.appData.sendSettings?.stickerRatio || 50) + (this.appData.sendSettings?.phraseRatio || 50);
                const stickerProbability = (this.appData.sendSettings?.stickerRatio || 50) / totalRatio;
                
                const messagesToSend = [];
                for (let i = 0; i < messageCount; i++) {
                    const isSticker = Math.random() < stickerProbability && this.appData.stickers?.length > 0;
                    if (isSticker) {
                        const randomSticker = this.appData.stickers[Math.floor(Math.random() * this.appData.stickers.length)];
                        messagesToSend.push({ type: 'sticker', data: randomSticker.data });
                    } else {
                        const randomPhrase = this.appData.responsePhrases[Math.floor(Math.random() * this.appData.responsePhrases.length)];
                        messagesToSend.push({ type: 'text', data: randomPhrase });
                    }
                }
                
                const firstMsg = messagesToSend[0];
                const firstMessage = {
                    id: this.dataManager.generateMessageId(),
                    isSticker: firstMsg.type === 'sticker',
                    [firstMsg.type === 'sticker' ? 'stickerData' : 'text']: firstMsg.data,
                    sender: 'other',
                    time: this.getCurrentTime(),
                    read: true
                };
                
                this.appData.messages.push(firstMessage);
                this.renderMessages();
                
                if (messagesToSend.length > 1) {
                    for (let i = 1; i < messagesToSend.length; i++) {
                        setTimeout(() => {
                            const msg = messagesToSend[i];
                            const additionalMessage = {
                                id: this.dataManager.generateMessageId(),
                                isSticker: msg.type === 'sticker',
                                [msg.type === 'sticker' ? 'stickerData' : 'text']: msg.data,
                                sender: 'other',
                                time: this.getCurrentTime(),
                                read: true
                            };
                            this.appData.messages.push(additionalMessage);
                            this.renderMessages();
                        }, i * 800 + Math.random() * 500);
                    }
                }
                
                this.showNotification('对方主动发送了消息');
                this.saveAllData();
            }
        }, 1000 + Math.random() * 2000);
    }
    
    quoteMessage(message) {
        if (!message) return;
        this.appData.quotedMessage = {
            id: message.id,
            text: message.text || '',
            isSticker: message.isSticker || false,
            stickerData: message.stickerData || null,
            sender: message.sender,
            time: message.time
        };
        let quoteText = message.isSticker ? '[表情包]' : (message.text ? (message.text.length > 30 ? message.text.substring(0, 30) + '...' : message.text) : '');
        const input = document.getElementById('messageInput');
        if (input) {
            input.placeholder = `回复 "${quoteText}"...`;
            input.focus();
        }
        this.showNotification('已引用消息');
    }
    
    deleteMessage(messageId) {
        if (!messageId) return;
        this.appData.messages = this.appData.messages.filter(msg => msg.id !== messageId);
        if (this.appData.readNoReplyMessageIds) {
            const index = this.appData.readNoReplyMessageIds.indexOf(messageId);
            if (index > -1) this.appData.readNoReplyMessageIds.splice(index, 1);
        }
        this.renderMessages();
        this.saveAllData();
        this.showNotification('消息已删除');
    }
    
    recallMessage(messageId) {
        if (!messageId) return;
        const messageIndex = this.appData.messages.findIndex(msg => msg.id === messageId);
        if (messageIndex === -1) return;
        if (this.appData.messages[messageIndex].sender !== 'self') {
            this.showNotification('只能撤回自己发送的消息');
            return;
        }
        this.appData.messages[messageIndex].text = '[已撤回]';
        this.appData.messages[messageIndex].isSticker = false;
        this.renderMessages();
        this.saveAllData();
        this.showNotification('消息已撤回');
    }
    
    selectTarotNumber(number) {
        if (!this.appData.tarotSettings) this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
        this.appData.tarotSettings.drawCount = number;
        const tarotCountValue = document.getElementById('tarotCountValue');
        if (tarotCountValue) tarotCountValue.textContent = number;
        document.querySelectorAll('.tarot-number').forEach(el => {
            el.classList.remove('active');
            if (parseInt(el.dataset.number) === number) el.classList.add('active');
        });
        this.saveAllData();
        this.showNotification(`抽取数量设置为: ${number}`);
    }
    
    saveTarotSettings() {
        const textarea = document.getElementById('tarotTextarea');
        if (!textarea) return;
        const phrases = textarea.value.trim().split('\n').map(p => p.trim()).filter(p => p.length > 0);
        if (!this.appData.tarotSettings) this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
        this.appData.tarotSettings.customPhrases = phrases;
        this.appData.drawnCards = new Set();
        this.updateTarotPhraseCount();
        this.updateTarotStatus();
        this.saveAllData();
        this.showNotification(`已保存 ${phrases.length} 张塔罗牌字卡`);
        this.closeSettingsPanel();
    }
    
    loadDefaultTarotCards() {
        if (!this.appData.tarotSettings) this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
        this.appData.tarotSettings.customPhrases = [...this.DEFAULT_TAROT_CARDS];
        const textarea = document.getElementById('tarotTextarea');
        if (textarea) textarea.value = this.DEFAULT_TAROT_CARDS.join('\n');
        this.updateTarotPhraseCount();
        this.updateTarotStatus();
        this.showNotification('已加载78张默认塔罗牌');
        this.appData.drawnCards = new Set();
        this.saveAllData();
    }
    
    clearTarotCards() {
        if (confirm('确定要清空所有塔罗牌字卡吗？')) {
            if (!this.appData.tarotSettings) this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
            this.appData.tarotSettings.customPhrases = [];
            const textarea = document.getElementById('tarotTextarea');
            if (textarea) textarea.value = '';
            this.updateTarotPhraseCount();
            this.updateTarotStatus();
            this.showNotification('已清空塔罗牌字卡');
            this.appData.drawnCards = new Set();
            this.saveAllData();
        }
    }
    
    savePhrases() {
        const textarea = document.getElementById('phrasesTextarea');
        if (!textarea) return;
        const text = textarea.value.trim();
        if (!text) {
            this.showNotification('请输入至少一个词条');
            return;
        }
        const phrases = text.split('\n').map(p => p.trim()).filter(p => p.length > 0);
        if (phrases.length === 0) {
            this.showNotification('请输入有效的词条');
            return;
        }
        this.appData.responsePhrases = phrases;
        this.updatePhraseCount();
        this.saveAllData();
        this.showNotification(`已保存 ${phrases.length} 个词条`);
        this.closeSettingsPanel();
    }
    
    saveAppearanceSettings() {
        const appTitleInput = document.getElementById('appTitleInput');
        const appSubtitleInput = document.getElementById('appSubtitleInput');
        const loveYear = document.getElementById('loveYear');
        const loveMonth = document.getElementById('loveMonth');
        const loveDay = document.getElementById('loveDay');
        const moodChangeFrequency = document.getElementById('moodChangeFrequency');
        
        if (!this.appData.appearanceSettings) {
            this.appData.appearanceSettings = { appTitle: '梦角爱人', appSubtitle: '绝对私密的一对一聊天空间', loveStartDate: new Date(2024, 0, 1), moodChangeFrequency: 600000 };
        }
        
        if (appTitleInput) this.appData.appearanceSettings.appTitle = appTitleInput.value || '梦角爱人';
        if (appSubtitleInput) this.appData.appearanceSettings.appSubtitle = appSubtitleInput.value || '绝对私密的一对一聊天空间';
        
        if (loveYear && loveMonth && loveDay) {
            const year = parseInt(loveYear.value) || 2024;
            const month = parseInt(loveMonth.value) - 1 || 0;
            const day = parseInt(loveDay.value) || 1;
            this.appData.appearanceSettings.loveStartDate = new Date(year, month, day);
        }
        
        if (moodChangeFrequency) this.appData.appearanceSettings.moodChangeFrequency = parseInt(moodChangeFrequency.value) || 600000;
        
        clearInterval(this.appData.moodTimer);
        this.startMoodChanging();
        
        this.calculateLoveDays();
        this.renderAppearance();
        this.saveAllData();
        this.showNotification('外观设置已保存');
        this.closeSettingsPanel();
    }
    
    saveBackgroundSettings() {
        const slider = document.getElementById('backgroundOpacitySlider');
        if (slider && this.appData.backgroundSettings) {
            this.appData.backgroundSettings.opacity = parseInt(slider.value);
        }
        this.saveAllData();
        this.showNotification('背景设置已保存');
        this.closeSettingsPanel();
    }
    
    saveCommunicationSettings() {
        const autoAcceptCalls = document.getElementById('autoAcceptCalls');
        const autoAcceptVideos = document.getElementById('autoAcceptVideos');
        if (!this.appData.communicationSettings) {
            this.appData.communicationSettings = { autoAcceptCalls: true, autoAcceptVideos: true, todayCalls: 0, todayVideos: 0, activeCallSettings: { enabled: true, overallFrequency: 30, callPreference: 50, presetMode: 'custom' } };
        }
        if (autoAcceptCalls) this.appData.communicationSettings.autoAcceptCalls = autoAcceptCalls.checked;
        if (autoAcceptVideos) this.appData.communicationSettings.autoAcceptVideos = autoAcceptVideos.checked;
        this.saveAllData();
        this.showNotification('通话设置已保存');
        this.closeSettingsPanel();
    }
    
    openSettings() {
        document.getElementById('settingsPanel')?.classList.add('active');
        document.getElementById('settingsOverlay')?.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    closeSettingsPanel() {
        document.getElementById('settingsPanel')?.classList.remove('active');
        document.getElementById('settingsOverlay')?.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    switchTab(tabId) {
        if (!document.getElementById('settingsPanel')?.classList.contains('active')) this.openSettings();
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `${tabId}Tab`);
        });
    }
    
    createCallWindow(type) {
        document.querySelector('.call-window')?.remove();
        const callWindow = document.createElement('div');
        callWindow.className = 'call-window';
        callWindow.style.left = '20px';
        callWindow.style.top = '20px';
        
        const avatarContent = this.appData.otherInfo?.avatar ? `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : '<span></span>';
        
        callWindow.innerHTML = `
            <div class="window-header">
                <div class="window-title"><i class="material-icons">call</i><span>语音通话</span></div>
                <div class="window-controls"><button class="window-btn" id="minimizeCall">−</button><button class="window-btn" id="closeCall">×</button></div>
            </div>
            <div class="window-content">
                <div class="call-avatar">${avatarContent}</div>
                <div class="calling-text">${type === 'outgoing' ? '等待对方接听...' : '对方来电...'}</div>
                ${type === 'incoming' ? '<div class="call-buttons"><button class="accept-btn" id="acceptCall"><i class="material-icons">call</i>接听</button><button class="reject-btn" id="rejectCall"><i class="material-icons">call_end</i>拒绝</button></div>' : ''}
            </div>
        `;
        
        document.body.appendChild(callWindow);
        this.appData.activeCall = callWindow;
        this.makeWindowDraggable(callWindow);
        
        if (type === 'incoming') {
            callWindow.querySelector('#acceptCall')?.addEventListener('click', () => this.answerCall());
            callWindow.querySelector('#rejectCall')?.addEventListener('click', () => this.rejectCall());
        }
        
        callWindow.querySelector('#closeCall')?.addEventListener('click', () => this.endCall());
        callWindow.querySelector('#minimizeCall')?.addEventListener('click', () => {
            callWindow.style.display = callWindow.style.display === 'none' ? 'flex' : 'none';
        });
        
        if (type === 'incoming' && this.appData.communicationSettings?.autoAcceptCalls) {
            setTimeout(() => { if (this.appData.activeCall === callWindow) this.answerCall(); }, 2000);
        }
    }
    
    createVideoWindow(type) {
        document.querySelector('.video-window')?.remove();
        const videoWindow = document.createElement('div');
        videoWindow.className = 'video-window';
        videoWindow.style.left = '40px';
        videoWindow.style.top = '40px';
        
        const avatarContent = this.appData.otherInfo?.avatar ? `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : '<span></span>';
        
        videoWindow.innerHTML = `
            <div class="window-header">
                <div class="window-title"><i class="material-icons">videocam</i><span>视频通话</span></div>
                <div class="window-controls"><button class="window-btn" id="minimizeVideo">−</button><button class="window-btn" id="closeVideo">×</button></div>
            </div>
            <div class="window-content">
                <div class="video-avatar">${avatarContent}</div>
                <div class="calling-text">${type === 'outgoing' ? '等待对方接听...' : '对方视频邀请...'}</div>
                ${type === 'incoming' ? '<div class="call-buttons"><button class="accept-btn" id="acceptVideo"><i class="material-icons">videocam</i>接听</button><button class="reject-btn" id="rejectVideo"><i class="material-icons">call_end</i>拒绝</button></div>' : ''}
            </div>
        `;
        
        document.body.appendChild(videoWindow);
        this.appData.activeVideo = videoWindow;
        this.makeWindowDraggable(videoWindow);
        
        if (type === 'incoming') {
            videoWindow.querySelector('#acceptVideo')?.addEventListener('click', () => this.answerVideo());
            videoWindow.querySelector('#rejectVideo')?.addEventListener('click', () => this.rejectVideo());
        }
        
        videoWindow.querySelector('#closeVideo')?.addEventListener('click', () => this.endVideo());
        videoWindow.querySelector('#minimizeVideo')?.addEventListener('click', () => {
            videoWindow.style.display = videoWindow.style.display === 'none' ? 'flex' : 'none';
        });
        
        if (type === 'incoming' && this.appData.communicationSettings?.autoAcceptVideos) {
            setTimeout(() => { if (this.appData.activeVideo === videoWindow) this.answerVideo(); }, 2000);
        }
    }
    
    makeWindowDraggable(windowElement) {
        let isDragging = false;
        let offsetX, offsetY;
        const header = windowElement.querySelector('.window-header');
        
        header.addEventListener('mousedown', (e) => {
            if (e.target.closest('.window-btn')) return;
            isDragging = true;
            const rect = windowElement.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            windowElement.classList.add('active');
            windowElement.style.transition = 'none';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const maxX = window.innerWidth - windowElement.offsetWidth;
            const maxY = window.innerHeight - windowElement.offsetHeight;
            let x = e.clientX - offsetX;
            let y = e.clientY - offsetY;
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            windowElement.style.left = `${x}px`;
            windowElement.style.top = `${y}px`;
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
            windowElement.classList.remove('active');
            windowElement.style.transition = '';
        });
        
        header.addEventListener('touchstart', (e) => {
            if (e.target.closest('.window-btn')) return;
            e.preventDefault();
            const touch = e.touches[0];
            isDragging = true;
            const rect = windowElement.getBoundingClientRect();
            offsetX = touch.clientX - rect.left;
            offsetY = touch.clientY - rect.top;
            windowElement.classList.add('active');
            windowElement.style.transition = 'none';
        }, { passive: false });
        
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const touch = e.touches[0];
            const maxX = window.innerWidth - windowElement.offsetWidth;
            const maxY = window.innerHeight - windowElement.offsetHeight;
            let x = touch.clientX - offsetX;
            let y = touch.clientY - offsetY;
            x = Math.max(0, Math.min(x, maxX));
            y = Math.max(0, Math.min(y, maxY));
            windowElement.style.left = `${x}px`;
            windowElement.style.top = `${y}px`;
        }, { passive: false });
        
        document.addEventListener('touchend', () => { isDragging = false; windowElement.classList.remove('active'); windowElement.style.transition = ''; });
        document.addEventListener('touchcancel', () => { isDragging = false; windowElement.classList.remove('active'); windowElement.style.transition = ''; });
    }
    
    answerCall() {
        if (!this.appData.activeCall) return;
        const content = this.appData.activeCall.querySelector('.window-content');
        if (!content) return;
        content.innerHTML = `
            <div class="call-avatar">${this.appData.otherInfo?.avatar ? `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : '<span></span>'}</div>
            <div class="in-call-text">正在通话中...</div>
            <div class="call-timer" id="callTimer">00:00</div>
            <div class="call-buttons"><button class="end-btn" id="endCall"><i class="material-icons">call_end</i>挂断</button></div>
        `;
        content.querySelector('#endCall')?.addEventListener('click', () => this.endCall());
        this.appData.callStartTime = new Date();
        this.startCallTimer();
    }
    
    answerVideo() {
        if (!this.appData.activeVideo) return;
        const content = this.appData.activeVideo.querySelector('.window-content');
        if (!content) return;
        content.innerHTML = `
            <div class="video-avatar">${this.appData.otherInfo?.avatar ? `<img src="${this.appData.otherInfo.avatar}" alt="${this.appData.otherInfo.nickname}">` : '<span></span>'}</div>
            <div class="in-call-text">正在视频通话中...</div>
            <div class="call-timer" id="videoTimer">00:00</div>
            <div class="call-buttons"><button class="end-btn" id="endVideo"><i class="material-icons">call_end</i>挂断</button></div>
        `;
        content.querySelector('#endVideo')?.addEventListener('click', () => this.endVideo());
        this.appData.callStartTime = new Date();
        this.startCallTimer();
    }
    
    rejectCall() {
        if (!this.appData.activeCall) return;
        this.appData.activeCall.remove();
        this.appData.activeCall = null;
        this.showNotification('已拒绝通话');
    }
    
    rejectVideo() {
        if (!this.appData.activeVideo) return;
        this.appData.activeVideo.remove();
        this.appData.activeVideo = null;
        this.showNotification('已拒绝视频通话');
    }
    
    endCall() {
        if (!this.appData.activeCall) return;
        const duration = Math.floor((new Date() - this.appData.callStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.totalCallTime = (this.appData.communicationSettings.totalCallTime || 0) + minutes;
        }
        this.appData.activeCall.remove();
        this.appData.activeCall = null;
        clearInterval(this.appData.callTimer);
        this.showNotification(`通话结束`);
        this.saveAllData();
    }
    
    endVideo() {
        if (!this.appData.activeVideo) return;
        const duration = Math.floor((new Date() - this.appData.callStartTime) / 1000);
        const minutes = Math.floor(duration / 60);
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.totalVideoTime = (this.appData.communicationSettings.totalVideoTime || 0) + minutes;
        }
        this.appData.activeVideo.remove();
        this.appData.activeVideo = null;
        clearInterval(this.appData.callTimer);
        this.showNotification(`视频结束`);
        this.saveAllData();
    }
    
    startCall() {
        if (this.appData.activeCall) { this.showNotification('通话进行中'); return; }
        this.createCallWindow('outgoing');
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.todayCalls = (this.appData.communicationSettings.todayCalls || 0) + 1;
            this.saveAllData();
        }
        setTimeout(() => { if (this.appData.activeCall) this.answerCall(); }, 3000 + Math.random() * 3000);
    }
    
    startVideo() {
        if (this.appData.activeVideo) { this.showNotification('视频进行中'); return; }
        this.createVideoWindow('outgoing');
        if (this.appData.communicationSettings) {
            this.appData.communicationSettings.todayVideos = (this.appData.communicationSettings.todayVideos || 0) + 1;
            this.saveAllData();
        }
        setTimeout(() => { if (this.appData.activeVideo) this.answerVideo(); }, 3000 + Math.random() * 3000);
    }
    
    startCallTimer() {
        clearInterval(this.appData.callTimer);
        let seconds = 0;
        this.appData.callTimer = setInterval(() => {
            seconds++;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            const callTimer = document.getElementById('callTimer');
            const videoTimer = document.getElementById('videoTimer');
            if (callTimer) callTimer.textContent = timerText;
            if (videoTimer) videoTimer.textContent = timerText;
        }, 1000);
    }
    
    handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        this.compressImage(file, { maxWidth: 300, maxHeight: 300, quality: 0.7 })
            .then(compressedDataUrl => {
                const imageMessage = {
                    id: this.dataManager.generateMessageId(),
                    isSticker: true,
                    stickerData: compressedDataUrl,
                    sender: 'self',
                    time: this.getCurrentTime(),
                    read: false,
                    quotedMessage: this.appData.quotedMessage ? {...this.appData.quotedMessage} : null
                };
                
                this.appData.messages.push(imageMessage);
                this.renderMessages();
                
                this.appData.quotedMessage = null;
                const input = document.getElementById('messageInput');
                if (input) input.placeholder = '输入消息...';
                
                this.saveAllData();
                
                setTimeout(() => {
                    if (Math.random() > 0.3) {
                        this.appData.waitingForReply = true;
                        this.startTypingIndicator();
                        setTimeout(() => {
                            if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                                this.generateTarotReply('reply');
                            } else {
                                this.generateReply(imageMessage.id);
                            }
                        }, 1500 + Math.random() * 2000);
                    } else {
                        this.markSelfMessagesAsRead();
                        if (imageMessage.id) {
                            if (!this.appData.readNoReplyMessageIds) this.appData.readNoReplyMessageIds = [];
                            this.appData.readNoReplyMessageIds.push(imageMessage.id);
                        }
                        this.renderMessages();
                        this.showNotification('对方已读不回');
                        this.saveAllData();
                    }
                }, 1000);
            });
        
        e.target.value = '';
    }
    
    handleStickerUpload(e) {
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            this.compressImage(file, { maxWidth: 200, maxHeight: 200, quality: 0.6 })
                .then(compressedDataUrl => {
                    const stickerData = { id: Date.now() + i, data: compressedDataUrl, name: file.name };
                    if (!this.appData.stickers) this.appData.stickers = [];
                    this.appData.stickers.push(stickerData);
                    this.renderStickerPreview();
                    this.saveAllData();
                    this.showNotification(`已添加表情包: ${file.name}`);
                });
        }
        e.target.value = '';
    }
    
    handleBackgroundUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            if (!this.appData.backgroundSettings) this.appData.backgroundSettings = { backgroundImage: null, opacity: 100 };
            this.appData.backgroundSettings.backgroundImage = e.target.result;
            this.updateBackgroundPreview();
            this.applyBackgroundSettings();
            this.saveAllData();
            this.showNotification('背景图片已上传');
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    }
    
    compressImage(file, options) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > height) {
                        if (width > options.maxWidth) {
                            height = Math.round(height * options.maxWidth / width);
                            width = options.maxWidth;
                        }
                    } else {
                        if (height > options.maxHeight) {
                            width = Math.round(width * options.maxHeight / height);
                            height = options.maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', options.quality));
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }
    
    removeBackground() {
        if (this.appData.backgroundSettings) {
            this.appData.backgroundSettings.backgroundImage = null;
            this.appData.backgroundSettings.opacity = 100;
        }
        const slider = document.getElementById('backgroundOpacitySlider');
        const value = document.getElementById('backgroundOpacityValue');
        if (slider) slider.value = 100;
        if (value) value.textContent = '100%';
        this.updateBackgroundPreview();
        this.applyBackgroundSettings();
        this.saveAllData();
        this.showNotification('已恢复默认背景');
    }
    
    openUserEditModal(userType) {
        this.appData.editingUserType = userType;
        const userInfo = userType === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) modalTitle.textContent = userType === 'self' ? '编辑我的信息' : '编辑对方信息';
        const modalNicknameInput = document.getElementById('modalNicknameInput');
        if (modalNicknameInput) modalNicknameInput.value = userInfo?.nickname || '';
        const avatarPreview = document.getElementById('avatarPreview');
        if (avatarPreview) {
            avatarPreview.innerHTML = '';
            if (userInfo?.avatar) avatarPreview.innerHTML = `<img src="${userInfo.avatar}" alt="${userInfo.nickname}">`;
        }
        const modal = document.getElementById('userModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }
    
    closeUserEditModal() {
        const modal = document.getElementById('userModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        this.appData.editingUserType = null;
    }
    
    saveUserInfo() {
        const userType = this.appData.editingUserType;
        if (!userType) return;
        const userInfo = userType === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
        if (!userInfo) return;
        const modalNicknameInput = document.getElementById('modalNicknameInput');
        if (modalNicknameInput && modalNicknameInput.value.trim()) userInfo.nickname = modalNicknameInput.value.trim();
        this.renderUserInfo();
        this.renderMessages();
        this.saveAllData();
        this.showNotification(`${userType === 'self' ? '我的' : '对方'}信息已更新`);
        this.closeUserEditModal();
    }
    
    handleAvatarUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const userType = this.appData.editingUserType;
        if (!userType) return;
        const userInfo = userType === 'self' ? this.appData.selfInfo : this.appData.otherInfo;
        if (!userInfo) return;
        this.compressImage(file, { maxWidth: 200, maxHeight: 200, quality: 0.7 })
            .then(compressedDataUrl => {
                userInfo.avatar = compressedDataUrl;
                const avatarPreview = document.getElementById('avatarPreview');
                if (avatarPreview) avatarPreview.innerHTML = `<img src="${userInfo.avatar}" alt="${userInfo.nickname}">`;
                this.showNotification('头像已更新');
                this.saveAllData();
            });
        e.target.value = '';
    }
    
    updateOverallFrequency() {
        const slider = document.getElementById('overallFrequencySlider');
        if (!slider) return;
        const value = parseInt(slider.value);
        if (!this.appData.communicationSettings) this.appData.communicationSettings = { activeCallSettings: {} };
        if (!this.appData.communicationSettings.activeCallSettings) this.appData.communicationSettings.activeCallSettings = {};
        this.appData.communicationSettings.activeCallSettings.overallFrequency = value;
        this.appData.communicationSettings.activeCallSettings.enabled = value > 0;
        this.appData.communicationSettings.activeCallSettings.presetMode = 'custom';
        this.updateOverallFrequencyDisplay();
        this.updatePresetButtons();
        this.restartActiveCallScheduler();
        this.saveAllData();
    }
    
    updateCallPreference() {
        const slider = document.getElementById('callPreferenceSlider');
        if (!slider) return;
        const value = parseInt(slider.value);
        if (!this.appData.communicationSettings) this.appData.communicationSettings = { activeCallSettings: {} };
        if (!this.appData.communicationSettings.activeCallSettings) this.appData.communicationSettings.activeCallSettings = {};
        this.appData.communicationSettings.activeCallSettings.callPreference = value;
        this.appData.communicationSettings.activeCallSettings.presetMode = 'custom';
        this.updateCallPreferenceDisplay();
        this.updatePresetButtons();
        this.saveAllData();
    }
    
    applyPresetMode(preset) {
        if (!this.PRESET_MODES[preset]) return;
        const presetConfig = this.PRESET_MODES[preset];
        if (!this.appData.communicationSettings) this.appData.communicationSettings = { activeCallSettings: {} };
        if (!this.appData.communicationSettings.activeCallSettings) this.appData.communicationSettings.activeCallSettings = {};
        this.appData.communicationSettings.activeCallSettings.overallFrequency = presetConfig.overallFrequency || 30;
        this.appData.communicationSettings.activeCallSettings.callPreference = presetConfig.callPreference || 50;
        this.appData.communicationSettings.activeCallSettings.presetMode = preset;
        
        const freqSlider = document.getElementById('overallFrequencySlider');
        const prefSlider = document.getElementById('callPreferenceSlider');
        if (freqSlider) freqSlider.value = this.appData.communicationSettings.activeCallSettings.overallFrequency;
        if (prefSlider) prefSlider.value = this.appData.communicationSettings.activeCallSettings.callPreference;
        
        this.updateOverallFrequencyDisplay();
        this.updateCallPreferenceDisplay();
        this.updatePresetButtons();
        this.restartActiveCallScheduler();
        this.showNotification(`已切换到${presetConfig.name}`);
        this.saveAllData();
    }
    
    restartActiveCallScheduler() {
        if (this.appData.activeCallTimer) clearInterval(this.appData.activeCallTimer);
        this.startActiveCallScheduler();
    }
    
    importCloudData() {
        const textarea = document.getElementById('cloudImportTextarea');
        if (!textarea) return;
        const jsonText = textarea.value.trim();
        if (!jsonText) { this.showNotification('请输入数据'); return; }
        try {
            const importedData = JSON.parse(jsonText);
            if (!importedData.appData && !importedData.messages) { this.showNotification('数据格式错误'); return; }
            if (confirm('导入将覆盖当前数据，确定吗？')) {
                if (importedData.appData) {
                    if (importedData.appData.selfInfo) this.appData.selfInfo = importedData.appData.selfInfo;
                    if (importedData.appData.otherInfo) this.appData.otherInfo = importedData.appData.otherInfo;
                    if (importedData.appData.messages) this.appData.messages = importedData.appData.messages;
                    if (importedData.appData.responsePhrases) this.appData.responsePhrases = importedData.appData.responsePhrases;
                    if (importedData.appData.stickers) this.appData.stickers = importedData.appData.stickers;
                    if (importedData.appData.sendSettings) this.appData.sendSettings = importedData.appData.sendSettings;
                    if (importedData.appData.appearanceSettings) {
                        this.appData.appearanceSettings = importedData.appData.appearanceSettings;
                        if (this.appData.appearanceSettings.loveStartDate) this.appData.appearanceSettings.loveStartDate = new Date(this.appData.appearanceSettings.loveStartDate);
                    }
                    if (importedData.appData.backgroundSettings) this.appData.backgroundSettings = importedData.appData.backgroundSettings;
                    if (importedData.appData.tarotSettings) this.appData.tarotSettings = importedData.appData.tarotSettings;
                    if (importedData.appData.communicationSettings) this.appData.communicationSettings = importedData.appData.communicationSettings;
                    if (importedData.appData.musicSettings) this.appData.musicSettings = importedData.appData.musicSettings;
                } else {
                    if (importedData.messages) this.appData.messages = importedData.messages;
                    if (importedData.phrases) this.appData.responsePhrases = importedData.phrases;
                    if (importedData.stickers) this.appData.stickers = importedData.stickers;
                }
                this.renderAllUI();
                this.saveAllData();
                this.showNotification('导入成功！');
                textarea.value = '';
                this.closeSettingsPanel();
            }
        } catch (error) {
            this.showNotification('导入失败：JSON格式错误');
        }
    }
    
    clearCloudTextarea() {
        const textarea = document.getElementById('cloudImportTextarea');
        if (textarea) { textarea.value = ''; this.showNotification('已清空'); }
    }
    
    handleCloudFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const textarea = document.getElementById('cloudImportTextarea');
            if (textarea) textarea.value = event.target.result;
            this.showNotification('文件已加载');
        };
        reader.readAsText(file);
        e.target.value = '';
    }
    
    exportChatHistory(format) {
        const exportData = { messages: this.appData.messages, phrases: this.appData.responsePhrases, exportTime: new Date().toISOString() };
        let content = '', filename = '', mimeType = '';
        switch (format) {
            case 'txt':
                content = JSON.stringify(exportData, null, 2);
                filename = `聊天记录_${this.getFormattedDate()}.txt`;
                mimeType = 'text/plain';
                break;
            case 'json':
                content = JSON.stringify(exportData, null, 2);
                filename = `聊天记录_${this.getFormattedDate()}.json`;
                mimeType = 'application/json';
                break;
            default:
                content = JSON.stringify(exportData, null, 2);
                filename = `聊天记录_${this.getFormattedDate()}.txt`;
                mimeType = 'text/plain';
        }
        this.downloadFile(content, filename, mimeType);
        this.showNotification(`已导出为${format.toUpperCase()}`);
    }
    
    exportAllData() {
        const exportData = { appData: this.appData, exportTime: new Date().toISOString() };
        const content = JSON.stringify(exportData, null, 2);
        const filename = `完整备份_${this.getFormattedDate()}.json`;
        this.downloadFile(content, filename, 'application/json');
        this.showNotification('完整备份已导出');
    }
    
    getFormattedDate() {
        const now = new Date();
        return `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
    }
    
    downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    clearAllData() {
        if (confirm('确定要清除所有数据吗？')) {
            this.dataManager.clearAllData();
            this.loadAllData();
            this.renderAllUI();
            this.showNotification('已恢复默认设置');
            this.closeSettingsPanel();
        }
    }
    
    setupEventListeners() {
        document.getElementById('sendButton')?.addEventListener('click', () => this.sendMessage());
        document.getElementById('messageInput')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.sendMessage(); });
        document.getElementById('continueButton')?.addEventListener('click', () => this.requestContinueMessages());
        
        const uploadBtn = document.getElementById('uploadImageButton');
        const imageUpload = document.getElementById('imageUpload');
        if (uploadBtn && imageUpload) {
            uploadBtn.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', (e) => this.handleImageUpload(e));
        }
        
        document.getElementById('settingsToggle')?.addEventListener('click', () => this.openSettings());
        
        // 夜间模式切换 - 修复背景覆盖问题
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('night-mode');
                const icon = themeToggle.querySelector('i');
                if (icon) {
                    icon.textContent = document.documentElement.classList.contains('night-mode') ? 'light_mode' : 'dark_mode';
                }
                
                // 确保背景完全覆盖
                if (document.documentElement.classList.contains('night-mode')) {
                    document.body.style.backgroundColor = '#0a0a0a';
                    document.documentElement.style.backgroundColor = '#0a0a0a';
                    const bgContainer = document.getElementById('backgroundContainer');
                    if (bgContainer && bgContainer.style.backgroundImage) {
                        bgContainer.style.filter = 'brightness(0.15) contrast(1.2)';
                    }
                } else {
                    document.body.style.backgroundColor = '';
                    document.documentElement.style.backgroundColor = '';
                    const bgContainer = document.getElementById('backgroundContainer');
                    if (bgContainer) {
                        bgContainer.style.filter = '';
                    }
                }
            });
        }
        
        document.getElementById('settingsOverlay')?.addEventListener('click', () => this.closeSettingsPanel());
        document.getElementById('closeSettings')?.addEventListener('click', () => this.closeSettingsPanel());
        
        const addStickerBtn = document.getElementById('addStickerBtn');
        const stickerUpload = document.getElementById('stickerUpload');
        if (addStickerBtn && stickerUpload) {
            addStickerBtn.addEventListener('click', () => stickerUpload.click());
            stickerUpload.addEventListener('change', (e) => this.handleStickerUpload(e));
        }
        
        document.getElementById('savePhrasesBtn')?.addEventListener('click', () => this.savePhrases());
        
        const tarotModeToggle = document.getElementById('tarotModeToggle');
        if (tarotModeToggle) {
            tarotModeToggle.addEventListener('change', () => {
                if (!this.appData.tarotSettings) this.appData.tarotSettings = { enabled: false, drawCount: 1, customPhrases: [] };
                this.appData.tarotSettings.enabled = tarotModeToggle.checked;
                this.updateTarotStatus();
                this.saveAllData();
                this.showNotification(`塔罗牌模式 ${this.appData.tarotSettings.enabled ? '开启' : '关闭'}`);
            });
        }
        
        document.getElementById('saveTarotBtn')?.addEventListener('click', () => this.saveTarotSettings());
        document.getElementById('tarotTextarea')?.addEventListener('input', () => this.updateTarotPhraseCount());
        document.getElementById('loadDefaultTarotBtn')?.addEventListener('click', () => this.loadDefaultTarotCards());
        document.getElementById('clearTarotBtn')?.addEventListener('click', () => this.clearTarotCards());
        
        const uploadBackgroundOption = document.getElementById('uploadBackgroundOption');
        const backgroundUpload = document.getElementById('backgroundUpload');
        if (uploadBackgroundOption && backgroundUpload) {
            uploadBackgroundOption.addEventListener('click', () => backgroundUpload.click());
            backgroundUpload.addEventListener('change', (e) => this.handleBackgroundUpload(e));
        }
        
        document.getElementById('removeBackgroundBtn')?.addEventListener('click', () => this.removeBackground());
        
        const bgOpacitySlider = document.getElementById('backgroundOpacitySlider');
        if (bgOpacitySlider) {
            bgOpacitySlider.addEventListener('input', (e) => {
                const value = e.target.value;
                const display = document.getElementById('backgroundOpacityValue');
                if (display) display.textContent = `${value}%`;
                if (this.appData.backgroundSettings) {
                    this.appData.backgroundSettings.opacity = parseInt(value);
                    this.applyBackgroundSettings();
                }
            });
        }
        
        document.getElementById('saveBackgroundBtn')?.addEventListener('click', () => this.saveBackgroundSettings());
        
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => this.switchTab(btn.getAttribute('data-tab')));
        });
        
        const stickerRatioSlider = document.getElementById('stickerRatioSlider');
        if (stickerRatioSlider) {
            stickerRatioSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                document.getElementById('stickerRatioValue').textContent = `${value}%`;
                if (!this.appData.sendSettings) this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
                this.appData.sendSettings.stickerRatio = value;
                this.appData.sendSettings.phraseRatio = 100 - value;
                const phraseSlider = document.getElementById('phraseRatioSlider');
                const phraseDisplay = document.getElementById('phraseRatioValue');
                if (phraseSlider) phraseSlider.value = 100 - value;
                if (phraseDisplay) phraseDisplay.textContent = `${100 - value}%`;
                this.saveAllData();
            });
        }
        
        const phraseRatioSlider = document.getElementById('phraseRatioSlider');
        if (phraseRatioSlider) {
            phraseRatioSlider.addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                document.getElementById('phraseRatioValue').textContent = `${value}%`;
                if (!this.appData.sendSettings) this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
                this.appData.sendSettings.phraseRatio = value;
                this.appData.sendSettings.stickerRatio = 100 - value;
                const stickerSlider = document.getElementById('stickerRatioSlider');
                const stickerDisplay = document.getElementById('stickerRatioValue');
                if (stickerSlider) stickerSlider.value = 100 - value;
                if (stickerDisplay) stickerDisplay.textContent = `${100 - value}%`;
                this.saveAllData();
            });
        }
        
        document.getElementById('maxMessageCount')?.addEventListener('change', (e) => {
            if (!this.appData.sendSettings) this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
            this.appData.sendSettings.maxMessageCount = parseInt(e.target.value);
            this.saveAllData();
        });
        
        document.getElementById('autoSendFrequency')?.addEventListener('change', (e) => {
            if (!this.appData.sendSettings) this.appData.sendSettings = { stickerRatio: 50, phraseRatio: 50, maxMessageCount: 3, autoSendFrequency: 600000 };
            this.appData.sendSettings.autoSendFrequency = parseInt(e.target.value);
            this.restartAutoSending();
            this.saveAllData();
        });
        
        document.getElementById('saveAppearanceBtn')?.addEventListener('click', () => this.saveAppearanceSettings());
        
        document.getElementById('startCallButton')?.addEventListener('click', () => this.startCall());
        document.getElementById('startVideoButton')?.addEventListener('click', () => this.startVideo());
        
        document.getElementById('autoAcceptCalls')?.addEventListener('change', (e) => {
            if (!this.appData.communicationSettings) this.appData.communicationSettings = { autoAcceptCalls: true };
            this.appData.communicationSettings.autoAcceptCalls = e.target.checked;
            this.saveAllData();
        });
        
        document.getElementById('autoAcceptVideos')?.addEventListener('change', (e) => {
            if (!this.appData.communicationSettings) this.appData.communicationSettings = { autoAcceptVideos: true };
            this.appData.communicationSettings.autoAcceptVideos = e.target.checked;
            this.saveAllData();
        });
        
        document.getElementById('saveCommunicationBtn')?.addEventListener('click', () => this.saveCommunicationSettings());
        
        document.getElementById('overallFrequencySlider')?.addEventListener('input', () => this.updateOverallFrequency());
        document.getElementById('callPreferenceSlider')?.addEventListener('input', () => this.updateCallPreference());
        
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', (e) => this.applyPresetMode(e.currentTarget.getAttribute('data-preset')));
        });
        
        const musicUploadArea = document.getElementById('musicUploadArea');
        const musicUpload = document.getElementById('musicUpload');
        if (musicUploadArea && musicUpload) {
            musicUploadArea.addEventListener('click', () => musicUpload.click());
            musicUpload.addEventListener('change', (e) => this.handleMusicUpload(e));
        }
        
        document.getElementById('musicFrequencySlider')?.addEventListener('input', (e) => {
            const value = document.getElementById('musicFrequencyValue');
            if (value) value.textContent = `${e.target.value}%`;
        });
        
        document.getElementById('saveMusicSettingsBtn')?.addEventListener('click', () => this.saveMusicSettings());
        
        document.getElementById('importCloudBtn')?.addEventListener('click', () => this.importCloudData());
        document.getElementById('clearCloudBtn')?.addEventListener('click', () => this.clearCloudTextarea());
        
        const importFileBtn = document.getElementById('importFileBtn');
        const cloudFileUpload = document.getElementById('cloudFileUpload');
        if (importFileBtn && cloudFileUpload) {
            importFileBtn.addEventListener('click', () => cloudFileUpload.click());
            cloudFileUpload.addEventListener('change', (e) => this.handleCloudFileUpload(e));
        }
        
        document.getElementById('exportTxtBtn')?.addEventListener('click', () => this.exportChatHistory('txt'));
        document.getElementById('exportJsonBtn')?.addEventListener('click', () => this.exportChatHistory('json'));
        document.getElementById('exportHtmlBtn')?.addEventListener('click', () => this.exportChatHistory('html'));
        document.getElementById('exportAllBtn')?.addEventListener('click', () => this.exportAllData());
        
        document.getElementById('selfUserInfo')?.addEventListener('click', () => this.openUserEditModal('self'));
        document.getElementById('otherUserInfo')?.addEventListener('click', () => this.openUserEditModal('other'));
        
        document.getElementById('cancelEditBtn')?.addEventListener('click', () => this.closeUserEditModal());
        document.getElementById('saveUserInfoBtn')?.addEventListener('click', () => this.saveUserInfo());
        
        const uploadAvatarBtn = document.getElementById('uploadAvatarBtn');
        const modalAvatarUpload = document.getElementById('modalAvatarUpload');
        if (uploadAvatarBtn && modalAvatarUpload) {
            uploadAvatarBtn.addEventListener('click', () => modalAvatarUpload.click());
            modalAvatarUpload.addEventListener('change', (e) => this.handleAvatarUpload(e));
        }
        
        const clearAllDataBtn = document.createElement('button');
        clearAllDataBtn.className = 'remove-background-btn';
        clearAllDataBtn.style.marginTop = '15px';
        clearAllDataBtn.style.background = '#d32f2f';
        clearAllDataBtn.innerHTML = '<i class="material-icons">delete_forever</i> 清除所有数据';
        clearAllDataBtn.addEventListener('click', () => this.clearAllData());
        const exportTab = document.getElementById('exportTab');
        if (exportTab && !exportTab.querySelector('.clear-all-data-btn')) {
            clearAllDataBtn.classList.add('clear-all-data-btn');
            exportTab.appendChild(clearAllDataBtn);
        }
        
        document.addEventListener('click', (e) => {
            if (this.appData.activeMessageActions && !this.appData.activeMessageActions.contains(e.target) && !e.target.closest('.message')) {
                this.appData.activeMessageActions.style.display = 'none';
                this.appData.activeMessageActions = null;
            }
        });
    }
    
    restartAutoSending() {
        if (this.appData.autoSendTimer) clearInterval(this.appData.autoSendTimer);
        this.startAutoSending();
    }
    
    requestContinueMessages() {
        this.appData.isTyping = true;
        this.renderMessages();
        setTimeout(() => {
            this.appData.isTyping = false;
            if (this.appData.tarotSettings?.enabled && this.appData.tarotSettings.customPhrases?.length > 0) {
                this.generateTarotReply('continue');
                this.showNotification(`对方抽取了塔罗牌 🔮`);
            } else {
                this.autoSendMessage();
            }
        }, 1000 + Math.random() * 2000);
    }
    
    initMusicSettingsUI() {
        const musicFrequencySlider = document.getElementById('musicFrequencySlider');
        const musicFrequencyValue = document.getElementById('musicFrequencyValue');
        const autoPlayMusic = document.getElementById('autoPlayMusic');
        
        if (!this.appData.musicSettings) this.appData.musicSettings = { musicList: [], autoPlayMusic: true, musicFrequency: 30, playMode: 'random' };
        if (musicFrequencySlider && this.appData.musicSettings) musicFrequencySlider.value = this.appData.musicSettings.musicFrequency || 30;
        if (musicFrequencyValue && this.appData.musicSettings) musicFrequencyValue.textContent = `${this.appData.musicSettings.musicFrequency || 30}%`;
        if (autoPlayMusic && this.appData.musicSettings) autoPlayMusic.checked = this.appData.musicSettings.autoPlayMusic !== false;
        this.renderMusicList();
    }
    
    renderMusicList() {
        const musicListEl = document.getElementById('musicList');
        if (!musicListEl) return;
        if (!this.appData.musicSettings) this.appData.musicSettings = { musicList: [] };
        const musicList = this.appData.musicSettings.musicList || [];
        
        if (musicList.length === 0) {
            musicListEl.innerHTML = '<div class="music-empty"><i class="material-icons">library_music</i><span>暂无音乐</span></div>';
            return;
        }
        
        musicListEl.innerHTML = '';
        musicList.forEach((music, index) => {
            const musicCard = document.createElement('div');
            musicCard.className = 'music-item-card';
            const size = music.size ? (music.size / 1024 / 1024).toFixed(2) + 'MB' : '未知';
            musicCard.innerHTML = `
                <div class="music-item-icon"><i class="material-icons">music_note</i></div>
                <div class="music-item-info"><div class="music-item-name">${music.name || '未知'}</div><div class="music-item-size">${size}</div></div>
                <div class="music-item-actions">
                    <button class="music-item-play" data-index="${index}"><i class="material-icons">play_arrow</i> 播放</button>
                    <button class="music-item-delete" data-index="${index}"><i class="material-icons">delete</i></button>
                </div>
            `;
            musicCard.querySelector('.music-item-play')?.addEventListener('click', (e) => { e.stopPropagation(); this.openMusicPlayer(music); });
            musicCard.querySelector('.music-item-delete')?.addEventListener('click', (e) => { e.stopPropagation(); this.deleteMusic(index); });
            musicListEl.appendChild(musicCard);
        });
    }
    
    handleMusicUpload(e) {
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (!file.type.startsWith('audio/')) { this.showNotification('请上传音频文件'); continue; }
            if (file.size > 10 * 1024 * 1024) { this.showNotification(`文件 ${file.name} 超过10MB`); continue; }
            const reader = new FileReader();
            reader.onload = (event) => {
                const musicData = { id: Date.now() + i + Math.random(), name: file.name.replace(/\.[^/.]+$/, ''), data: event.target.result, size: file.size };
                if (!this.appData.musicSettings) this.appData.musicSettings = { musicList: [] };
                if (!this.appData.musicSettings.musicList) this.appData.musicSettings.musicList = [];
                this.appData.musicSettings.musicList.push(musicData);
                this.renderMusicList();
                this.saveAllData();
                this.showNotification(`已添加: ${musicData.name}`);
            };
            reader.readAsDataURL(file);
        }
        e.target.value = '';
    }
    
    deleteMusic(index) {
        if (!this.appData.musicSettings?.musicList) return;
        const musicName = this.appData.musicSettings.musicList[index]?.name;
        if (confirm(`确定要删除《${musicName}》吗？`)) {
            this.appData.musicSettings.musicList.splice(index, 1);
            this.renderMusicList();
            this.saveAllData();
            this.showNotification(`已删除: ${musicName}`);
            if (this.appData.activeMusicPlayer && this.appData.currentPlayingMusic?.id === this.appData.musicSettings.musicList[index]?.id) {
                this.closeMusicPlayer();
            }
        }
    }
    
    openMusicPlayer(music) {
        document.querySelector('.music-window')?.remove();
        this.appData.currentPlayingMusic = music;
        const musicWindow = document.createElement('div');
        musicWindow.className = 'music-window';
        musicWindow.style.left = '60px';
        musicWindow.style.top = '120px';
        const coverImage = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBkPSJNMTIgM2MtNC45NyAwLTkgNC4wMy05IDlzNC4wMyA5IDkgOSA5LTQuMDMgOS05LTQuMDMtOS05LTl6bTAgMTZjLTMuODYgMC03LTMuMTQtNy03czMuMTQtNyA3LTcgNyAzLjE0IDcgNy0zLjE0IDctNyA3eiIgZmlsbD0iIzhhN2Y4ZCIvPjxwYXRoIGQ9Ik0xMCA5djZsNS0zLTUtM3oiIGZpbGw9IiM4YTdmOGQiLz48L3N2Zz4=';
        musicWindow.innerHTML = `
            <div class="window-header">
                <div class="window-title"><i class="material-icons">music_note</i><span>音乐播放器</span></div>
                <div class="window-controls"><button class="window-btn" id="minimizeMusic">−</button><button class="window-btn" id="closeMusic">×</button></div>
            </div>
            <div class="window-content" style="padding: 0;">
                <div class="music-cd-container">
                    <div class="music-cd" id="musicCd"><img src="${coverImage}" alt="CD"></div>
                    <div class="music-info">
                        <div class="music-title" id="musicTitle">${music.name || '未知'}</div>
                        <div class="music-progress-container">
                            <div class="music-progress-bar" id="musicProgressBar"><div class="music-progress-fill" id="musicProgressFill" style="width: 0%;"></div></div>
                            <div class="music-time"><span id="currentTime">00:00</span><span id="duration">00:00</span></div>
                        </div>
                        <div class="music-controls-bar">
                            <button class="music-control-btn" id="prevMusic"><i class="material-icons">skip_previous</i></button>
                            <button class="music-control-btn" id="playPauseMusic" style="background: #8a7f8d; color: white;"><i class="material-icons">play_arrow</i></button>
                            <button class="music-control-btn" id="nextMusic"><i class="material-icons">skip_next</i></button>
                            <button class="music-control-btn" id="closeMusicPlayer"><i class="material-icons">close</i></button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(musicWindow);
        this.appData.activeMusicPlayer = musicWindow;
        this.appData.isMusicPlaying = false;
        this.appData.musicAudio = null;
        this.makeWindowDraggable(musicWindow);
        this.initMusicAudio(music);
        
        musicWindow.querySelector('#playPauseMusic')?.addEventListener('click', () => this.toggleMusicPlay());
        musicWindow.querySelector('#prevMusic')?.addEventListener('click', () => this.playPrevMusic());
        musicWindow.querySelector('#nextMusic')?.addEventListener('click', () => this.playNextMusic());
        musicWindow.querySelector('#closeMusic')?.addEventListener('click', () => this.closeMusicPlayer());
        musicWindow.querySelector('#closeMusicPlayer')?.addEventListener('click', () => this.closeMusicPlayer());
        musicWindow.querySelector('#minimizeMusic')?.addEventListener('click', () => {
            musicWindow.style.display = musicWindow.style.display === 'none' ? 'flex' : 'none';
        });
        musicWindow.querySelector('#musicProgressBar')?.addEventListener('click', (e) => this.seekMusic(e));
        musicWindow.querySelector('#musicCd')?.addEventListener('click', () => this.toggleMusicPlay());
    }
    
    initMusicAudio(music) {
        if (!music || !music.data) return;
        if (this.appData.musicAudio) { this.appData.musicAudio.pause(); this.appData.musicAudio = null; }
        const audio = new Audio(music.data);
        audio.volume = 0.8;
        
        audio.addEventListener('loadedmetadata', () => {
            const duration = document.getElementById('duration');
            if (duration) duration.textContent = this.formatTime(audio.duration);
        });
        
        audio.addEventListener('timeupdate', () => {
            if (!this.appData.activeMusicPlayer) return;
            const currentTime = document.getElementById('currentTime');
            const progressFill = document.getElementById('musicProgressFill');
            if (currentTime) currentTime.textContent = this.formatTime(audio.currentTime);
            if (progressFill) progressFill.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
        });
        
        audio.addEventListener('ended', () => this.handleMusicEnded());
        this.appData.musicAudio = audio;
    }
    
    toggleMusicPlay() {
        if (!this.appData.musicAudio) return;
        const playPauseBtn = document.querySelector('#playPauseMusic i');
        const cd = document.querySelector('#musicCd');
        if (this.appData.isMusicPlaying) {
            this.appData.musicAudio.pause();
            if (playPauseBtn) playPauseBtn.textContent = 'play_arrow';
            if (cd) cd.classList.remove('playing');
        } else {
            this.appData.musicAudio.play();
            if (playPauseBtn) playPauseBtn.textContent = 'pause';
            if (cd) cd.classList.add('playing');
        }
        this.appData.isMusicPlaying = !this.appData.isMusicPlaying;
    }
    
    seekMusic(e) {
        if (!this.appData.musicAudio) return;
        const progressBar = document.getElementById('musicProgressBar');
        const rect = progressBar.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        this.appData.musicAudio.currentTime = percent * this.appData.musicAudio.duration;
    }
    
    playPrevMusic() {
        const musicList = this.appData.musicSettings?.musicList || [];
        if (musicList.length === 0) { this.closeMusicPlayer(); return; }
        const currentMusic = this.appData.currentPlayingMusic;
        let index = musicList.findIndex(m => m.id === currentMusic?.id);
        index = (index - 1 + musicList.length) % musicList.length;
        this.openMusicPlayer(musicList[index]);
    }
    
    playNextMusic() {
        const musicList = this.appData.musicSettings?.musicList || [];
        if (musicList.length === 0) { this.closeMusicPlayer(); return; }
        const currentMusic = this.appData.currentPlayingMusic;
        let index = musicList.findIndex(m => m.id === currentMusic?.id);
        index = (index + 1) % musicList.length;
        this.openMusicPlayer(musicList[index]);
    }
    
    handleMusicEnded() {
        const playMode = this.appData.musicSettings?.playMode || 'random';
        if (playMode === 'single') {
            this.appData.musicAudio.currentTime = 0;
            this.appData.musicAudio.play();
        } else {
            this.playNextMusic();
        }
    }
    
    closeMusicPlayer() {
        if (this.appData.musicAudio) { this.appData.musicAudio.pause(); this.appData.musicAudio = null; }
        if (this.appData.activeMusicPlayer) { this.appData.activeMusicPlayer.remove(); this.appData.activeMusicPlayer = null; }
        this.appData.isMusicPlaying = false;
    }
    
    saveMusicSettings() {
        const autoPlayMusic = document.getElementById('autoPlayMusic');
        const musicFrequencySlider = document.getElementById('musicFrequencySlider');
        if (!this.appData.musicSettings) this.appData.musicSettings = { musicList: [] };
        if (autoPlayMusic) this.appData.musicSettings.autoPlayMusic = autoPlayMusic.checked;
        if (musicFrequencySlider) this.appData.musicSettings.musicFrequency = parseInt(musicFrequencySlider.value);
        this.saveAllData();
        this.showNotification('音乐设置已保存');
        this.closeSettingsPanel();
    }
    
    startMusicScheduler() {
        if (this.appData.musicTimer) clearInterval(this.appData.musicTimer);
        const settings = this.appData.musicSettings;
        if (!settings || !settings.autoPlayMusic || settings.musicFrequency <= 0) return;
        const baseInterval = 300000;
        const checkInterval = baseInterval * (100 / Math.max(settings.musicFrequency, 10));
        this.appData.musicTimer = setInterval(() => this.simulateMusicPlay(), checkInterval);
    }
    
    simulateMusicPlay() {
        const settings = this.appData.musicSettings;
        if (!settings || !settings.autoPlayMusic) return;
        const musicList = settings.musicList || [];
        if (musicList.length === 0) return;
        if (Math.random() * 100 > (settings.musicFrequency || 30)) return;
        const randomIndex = Math.floor(Math.random() * musicList.length);
        const selectedMusic = musicList[randomIndex];
        setTimeout(() => {
            this.openMusicPlayer(selectedMusic);
            const musicMessage = { id: this.dataManager.generateMessageId(), type: 'music', text: `对方播放了: ${selectedMusic.name}`, sender: 'other', time: this.getCurrentTime(), read: true };
            this.appData.messages.push(musicMessage);
            this.renderMessages();
            this.saveAllData();
            this.showNotification(`对方正在播放: ${selectedMusic.name}`);
        }, 1000 + Math.random() * 2000);
    }
    
    formatTime(seconds) {
        if (isNaN(seconds) || seconds < 0) return '00:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    showNotification(message) {
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => { if (notification.parentNode) notification.remove(); }, 3000);
    }
}

// ========================
// 启动应用
// ========================
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => { window.chatApp = new ChatApp(); });
} else {
    window.chatApp = new ChatApp();
}
</script>
</body>
</html>